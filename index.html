<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vade Sapmasƒ± Analizi (By_Oƒüuz)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- TEMEL AYARLAR --- */
        :root {
            --bg-color: #f4f7f6;
            --text-color: #333;
            --panel-bg: #fff;
            --input-bg: #fff;
            --input-border: #e0e0e0;
            --th-bg: #f8f9fa;
            --th-text: #555;
            --border-color: #eee;
            --shadow: rgba(0,0,0,0.05);
        }

        /* KARANLIK MOD DEƒûƒ∞≈ûKENLERƒ∞ */
        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --panel-bg: #1e1e1e;
            --input-bg: #2c2c2c;
            --input-border: #444;
            --th-bg: #252525;
            --th-text: #bbb;
            --border-color: #333;
            --shadow: rgba(0,0,0,0.5);
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); padding: 0; margin: 0; color: var(--text-color); box-sizing: border-box; height: 100vh; transition: background-color 0.3s, color 0.3s; }
        *, *:before, *:after { box-sizing: inherit; }
        
        /* --- Gƒ∞Rƒ∞≈û EKRANI --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4a90e2, #0056b3);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: white; padding: 40px 30px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
            width: 90%; max-width: 400px;
        }
        .login-box h2 { margin: 0 0 20px; color: #333; }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 2px solid #eee; border-radius: 8px; font-size: 16px;
        }
        .login-btn {
            width: 100%; padding: 12px; background-color: #4a90e2; color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: background 0.3s;
        }
        .login-btn:hover { background-color: #357abd; }
        .error-msg { color: #ef5350; margin-bottom: 15px; font-size: 14px; display: none; font-weight: bold; }

        /* --- UYGULAMA KAPSAYICISI --- */
        #app-container { display: none; padding: 20px; max-width: 1280px; margin: 0 auto; padding-bottom: 80px; }

        /* --- HEADER & TOOLBAR --- */
        .header-actions { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        .action-group-right { display: flex; gap: 10px; }

        .btn-action {
            background-color: var(--panel-bg); color: var(--text-color); border: 1px solid var(--input-border);
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .btn-action:hover { background-color: #e3f2fd; color: #1565c0; border-color: #1565c0; }
        
        .btn-logout { background: #ff5252; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px;}

        /* --- TOP BAR --- */
        .top-bar { background: var(--panel-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px var(--shadow); margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: flex-end; border: 1px solid var(--border-color); }
        .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 200px; }
        .input-group label { font-weight: 700; color: var(--th-text); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        .top-bar input { padding: 12px; border: 2px solid var(--input-border); border-radius: 8px; font-size: 16px; color: var(--text-color); background-color: var(--input-bg); text-align: center; font-weight: bold; width: 100%; -webkit-appearance: none; }
        .top-bar input:focus { border-color: #4a90e2; outline: none; }
        
        /* Klima Checkbox */
        .klima-wrapper {
            display: flex; align-items: center; justify-content: center;
            background: #e0f7fa; padding: 10px; border-radius: 8px; border: 1px solid #b2ebf2;
            height: 50px; margin-bottom: 2px; cursor: pointer; transition: background 0.3s;
        }
        [data-theme="dark"] .klima-wrapper { background: #004d40; border-color: #00695c; }
        [data-theme="dark"] .klima-wrapper label { color: #80cbc4; }

        .klima-wrapper input { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        .klima-wrapper label { cursor: pointer; font-weight: bold; color: #006064; font-size: 14px; user-select: none; }
        .label-active { color: #00acc1 !important; text-shadow: 0 0 8px rgba(0,172,193,0.4); font-weight: 900 !important; }

        /* --- PANELLER --- */
        .main-wrapper { display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap; }
        .panel { flex: 1; background-color: var(--panel-bg); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); overflow: hidden; display: flex; flex-direction: column; min-width: 300px; border: 1px solid var(--border-color); }
        .panel h3 { margin: 0; padding: 15px; text-align: center; font-size: 15px; color: #fff; letter-spacing: 0.5px; text-transform: uppercase; font-weight: 600; position: relative; }
        .panel-left h3 { background-color: #4a90e2; } 
        .panel-right h3 { background-color: #66bb6a; } 

        .klima-badge {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: #fff; color: #006064; font-size: 10px; padding: 3px 8px;
            border-radius: 10px; font-weight: 900; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
        }

        /* --- TABLO --- */
        .table-container { padding: 0; overflow-x: auto; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 400px; }
        th { background-color: var(--th-bg); color: var(--th-text); padding: 12px 8px; text-align: center; font-weight: 700; border-bottom: 2px solid var(--border-color); position: sticky; top: 0; z-index: 10; }
        td { padding: 8px 5px; border-bottom: 1px solid var(--border-color); vertical-align: middle; color: var(--text-color); }
        
        input[type="number"].input-tutar { width: 100%; padding: 8px; border: 1px solid var(--input-border); border-radius: 6px; text-align: right; font-weight: 600; font-size: 14px; background-color: var(--input-bg); color: var(--text-color); }
        input[type="date"].input-vade { width: 100%; padding: 7px; border: 1px solid var(--input-border); border-radius: 6px; text-align: center; font-family: inherit; font-size: 13px; background-color: var(--input-bg); color: var(--text-color); }
        .readonly-input { background-color: var(--bg-color) !important; cursor: default; }

        .input-wrapper { position: relative; margin-top: 5px; }
        .pesinat-badge { position: absolute; top: -20px; left: 0; font-size: 10px; background-color: #ff9800; color: white; padding: 2px 6px; border-radius: 4px 4px 0 0; font-weight: bold; z-index: 5; box-shadow: 0 -1px 2px rgba(0,0,0,0.1); display: none; }
        tr.first-row .pesinat-badge { display: block; }
        tr.first-row td { padding-top: 15px; }

        /* --- BUTONLAR --- */
        .btn-delete { background-color: #ff5252; color: white; border: none; cursor: pointer; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(255, 82, 82, 0.3); margin: 0 auto; }
        
        .btn-container { display: flex; gap: 8px; padding: 10px 15px; flex-wrap: wrap; }
        .btn-add { flex: 1; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--input-border); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 80px; }
        .btn-clear { flex: 0.5; background-color: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 60px; }
        .btn-copy { flex: 2; background-color: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; min-width: 110px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        
        [data-theme="dark"] .btn-add { background-color: #333; color: #eee; border-color: #555; }
        [data-theme="dark"] .btn-clear { background-color: #3e2723; color: #ffcc80; border-color: #5d4037; }
        [data-theme="dark"] .btn-copy { background-color: #0d47a1; color: #bbdefb; border-color: #1565c0; }

        /* --- √ñZET VE SONU√á --- */
        .summary-box { background-color: var(--th-bg); padding: 15px; border-top: 1px solid var(--border-color); font-size: 13px; margin-top: auto; }
        .row-sum { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .val { font-weight: bold; color: var(--text-color); font-family: monospace; font-size: 14px; }
        .avg-row { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); color: #4a90e2; font-size: 14px; font-weight: 800; }
        
        .result-area { margin-top: 20px; background-color: var(--panel-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow); display: flex; flex-direction: column; align-items: center; gap: 15px; border: 1px solid var(--border-color); }
        .result-top { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 20px; }
        .sapma-display { font-size: 28px; font-weight: 800; padding: 10px 20px; border-radius: 8px; min-width: 100px; text-align: center; color: #fff; transition: background-color 0.6s ease; }
        .warning-msg { color: #d32f2f; font-weight: bold; font-size: 12px; display: none; margin-top: 5px; text-align: left;}

        /* --- Rƒ∞SK √áUBUƒûU --- */
        .risk-wrapper { width: 100%; margin-top: 10px; }
        .risk-container { width: 100%; height: 18px; background-color: var(--bg-color); border-radius: 10px; overflow: hidden; position: relative; border: 1px solid var(--border-color); }
        .risk-bar { height: 100%; width: 0%; transition: width 0.6s, background-color 0.6s; border-radius: 10px; }
        .risk-text { text-align: center; font-size: 12px; font-weight: 800; margin-top: 6px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--th-text); }

        /* --- YASAL UYARI --- */
        .disclaimer-box { background-color: #fff8e1; border-left: 5px solid #ffb300; padding: 15px; margin-top: 20px; border-radius: 6px; font-size: 13px; color: #5d4037; line-height: 1.5; }
        [data-theme="dark"] .disclaimer-box { background-color: #3e2723; color: #ffe0b2; border-left-color: #ff6f00; }
        .disclaimer-box h4 { margin: 0 0 10px; color: #e65100; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .disclaimer-box ul { margin: 8px 0; padding-left: 20px; }
        .disclaimer-box li { margin-bottom: 5px; }
        .disclaimer-box strong { color: #bf360c; }
        [data-theme="dark"] .disclaimer-box strong { color: #ffab91; }

        /* --- MODAL (GE√áMƒ∞≈û) --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-content { background-color: var(--panel-bg); margin: 10% auto; padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-height: 70vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .close-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: var(--text-color); }
        .history-item { padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .history-item:last-child { border-bottom: none; }
        .history-info { font-size: 13px; }
        .history-date { font-size: 11px; color: var(--th-text); }
        .btn-restore { background: #4a90e2; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px;}
        .btn-del-hist { background: #ef5350; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        /* --- FOOTER --- */
        .footer-signature { text-align: center; margin-top: 50px; padding: 20px; border-top: 1px dashed var(--border-color); }
        .maras-text { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 900; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; background: linear-gradient(to right, #b71c1c, #ffc107, #b71c1c); background-size: 200% auto; color: #b71c1c; -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: shine 3s linear infinite; display: block; margin-bottom: 8px; }
        .author-text { font-family: 'Courier New', monospace; font-weight: bold; font-size: 18px; display: inline-block; animation: colorCycle 4s infinite alternate, pulse 2s infinite; }
        
        @keyframes shine { to { background-position: 200% center; } }
        @keyframes colorCycle { 0% { color: #ff0000; text-shadow: 0 0 5px rgba(255,0,0,0.3); } 25% { color: #00ff00; text-shadow: 0 0 5px rgba(0,255,0,0.3); } 50% { color: #0000ff; text-shadow: 0 0 5px rgba(0,0,255,0.3); } 75% { color: #ff00ff; text-shadow: 0 0 5px rgba(255,0,255,0.3); } 100% { color: #ff0000; text-shadow: 0 0 5px rgba(255,0,0,0.3); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        @media (max-width: 768px) {
            .main-wrapper { flex-direction: column; }
            .panel { width: 100%; min-width: auto; }
            .result-top { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>Ho≈ü Geldiniz</h2>
        <div id="loginError" class="error-msg">Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±!</div>
        <input type="text" id="username" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±" value="ihlas">
        <input type="password" id="password" class="login-input" placeholder="≈ûifre" value="">
        <label class="remember-me">
            <input type="checkbox" id="rememberMe"> Beni Hatƒ±rla
        </label>
        <button class="login-btn" onclick="checkLogin()">Gƒ∞Rƒ∞≈û YAP</button>
    </div>
</div>

<div id="app-container">
    <div class="header-actions">
        <button class="btn-logout" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
        
        <div class="action-group-right">
            <button class="btn-action" onclick="toggleDarkMode()" title="Karanlƒ±k Mod">
                <span id="themeIcon">üåô</span>
            </button>
            <button class="btn-action" onclick="showHistory()" title="Ge√ßmi≈ü Kayƒ±tlar">
                üìÅ Ge√ßmi≈ü
            </button>
            <button class="btn-action" onclick="saveSimulation()" title="Kaydet">
                üíæ Kaydet
            </button>
            <button class="btn-action" onclick="exportPDF()" title="PDF ƒ∞ndir">
                üìÑ PDF ƒ∞ndir
            </button>
        </div>
    </div>

    <div class="top-bar">
        <div class="input-group">
            <label>FATURA / REFERANS TARƒ∞Hƒ∞</label>
            <input type="date" id="satisTarihi">
        </div>
        <div class="input-group">
            <label>FATURA TUTARI (Cƒ∞RO)</label>
            <input type="number" id="targetCiro" placeholder="√ñrn: 34000">
            <div id="ciroWarning" class="warning-msg">Bu tutar i√ßin tanƒ±mlƒ± plan yok!</div>
        </div>
        <div class="input-group" style="min-width: 150px;">
             <label id="istisnaiLabel">ƒ∞STƒ∞SNAƒ∞ Fƒ∞YAT</label>
             <div class="klima-wrapper" onclick="toggleKlima()">
                 <input type="checkbox" id="klimaMode" onchange="generateTargetPlan()">
                 <label for="klimaMode">‚ùÑÔ∏è KLƒ∞MA SATI≈ûI</label>
             </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="panel panel-left">
            <h3>
                OLMASI GEREKEN (HEDEF)
                <span id="klimaIndicator" class="klima-badge">KLƒ∞MA</span>
            </h3>
            <div class="table-container">
                <table id="tableLeft">
                    <thead>
                        <tr><th style="width:30px;">No</th><th>Tutar</th><th>Vade Tarihi</th><th>G√ºn</th><th>√áarpan</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="summary-box">
                <div class="row-sum"><span>Toplam Ciro:</span><span class="val" id="leftCiro">0,00</span></div>
                <div class="row-sum"><span>Vade √áarpan Top:</span><span class="val" id="leftGunTutar">0,00</span></div>
                <div class="row-sum avg-row"><span>Ort. Vade G√ºn√º:</span><span class="val" id="leftAvg">0,00</span></div>
            </div>
        </div>

        <div class="panel panel-right">
            <h3>GER√áEKLE≈ûEN (OLAN)</h3>
            <div class="table-container">
                <table id="tableRight">
                    <thead>
                        <tr>
                            <th style="width:30px;">Sil</th>
                            <th style="width:30px;">No</th>
                            <th>Tutar</th>
                            <th>Vade Tarihi</th>
                            <th>G√ºn</th>
                            <th>√áarpan</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="btn-container">
                <button class="btn-copy" onclick="copyTargetToReal()">‚ö° Tabloyu Kopyala</button>
                <button class="btn-add" onclick="addManualRow()">+ Ekle</button>
                <button class="btn-clear" onclick="clearRightTable()">Temizle</button>
            </div>
            <div class="summary-box">
                <div class="row-sum"><span>Toplam Ciro:</span><span class="val" id="rightCiro">0,00</span></div>
                <div id="ciroStatusMsg" style="display:none; color:red; font-size:11px; text-align:right; font-weight:bold; margin-bottom:5px;">
                    ‚ö†Ô∏è Ciro E≈üit Deƒüil!
                </div>
                
                <div class="row-sum"><span>Vade √áarpan Top:</span><span class="val" id="rightGunTutar">0,00</span></div>
                <div class="row-sum avg-row" style="color: #66bb6a;"><span>Ort. Vade G√ºn√º:</span><span class="val" id="rightAvg">0,00</span></div>
            </div>
        </div>
    </div>

    <div class="result-area">
        <div class="result-top">
            <div style="color: var(--text-color); font-size:13px; flex:1; opacity: 0.8;">
                <div style="margin-bottom:5px;"><strong>‚ö° ƒ∞pucu:</strong> Sol tabloyu saƒüa aktarmak i√ßin <b>"Tabloyu Kopyala"</b> butonunu kullanƒ±n.</div>
                <div style="margin-bottom:5px;"><strong>üí° Taktik:</strong> Apg oranƒ± denemesi yaparken; satƒ±≈ü tarihini her ayƒ±n son g√ºn√º, ilk senet tarihini her ayƒ±n ilk g√ºn√º yapmanƒ±z taktirde vade tarihleri kƒ±salacaƒüƒ± i√ßin satƒ±≈üƒ±nƒ±zƒ±n girme olasƒ±lƒ±k ihtimali artacaktƒ±r.</div>
                Sol taraf otomatik dolar. Saƒü tarafa √∂demeleri ekleyin. ƒ∞lk satƒ±r Pe≈üinat'tƒ±r.
            </div>
            <div style="text-align: center; min-width: 180px;">
                <div style="font-size: 16px; font-weight: 600; color: var(--th-text); margin-bottom: 5px;">VADE SAPMASI</div>
                <div class="sapma-display" id="finalSapma">0,00</div>
            </div>
        </div>

        <div class="risk-wrapper">
            <div class="risk-container">
                <div id="riskBar" class="risk-bar"></div>
            </div>
            <div id="riskText" class="risk-text">VERƒ∞ BEKLENƒ∞YOR...</div>
        </div>
    </div>

    <div class="disclaimer-box">
        <h4>‚ö†Ô∏è √ñNEMLƒ∞ NOT</h4>
        <p>
            Payla≈üƒ±lan veriler ve hesaplamalar, Merkez tarafƒ±ndan belirlenen mevcut vade sapmasƒ± oranlarƒ± baz alƒ±narak hazƒ±rlanmƒ±≈ütƒ±r. 
            Bu oranlar piyasa ko≈üullarƒ±na veya merkez politikalarƒ±na g√∂re deƒüi≈üiklik g√∂sterebilir.
        </p>
        <p>Bu nedenle:</p>
        <ul>
            <li>Merkez oranlarƒ±nda herhangi bir g√ºncelleme yapƒ±lmasƒ± durumunda, l√ºtfen <strong>Muhasebe Departmanƒ±</strong> ile irtibata ge√ßiniz.</li>
            <li>Verileri kullanƒ±rken g√ºncelliƒüini teyit etmeniz ve deƒüi≈üen ko≈üullara kar≈üƒ± dikkatli olmanƒ±z √∂nem arz etmektedir.</li>
            <li><strong>Vade Sapmasƒ± oranƒ± 29'un altƒ±na d√º≈üerse</strong> satƒ±≈üƒ±n girme olasƒ±lƒ±ƒüƒ± istisnai durumlar haricinde vardƒ±r. Bu tablo bilgi ama√ßlƒ±dƒ±r.</li>
        </ul>
        <div style="margin-top:10px; font-style: italic; font-weight:600;">Bilgilerinize sunar, iyi √ßalƒ±≈ümalar dileriz.</div>
    </div>

    <div class="footer-signature">
        <span class="maras-text">üå∂Ô∏è Bƒ∞R KAHRAMANMARA≈û YAPIMIDIR üå∂Ô∏è</span>
        <span class="author-text">By_Oƒüuz</span>
    </div>

</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0; color:var(--text-color)">Ge√ßmi≈ü Hesaplamalar</h3>
            <span class="close-modal" onclick="closeHistory()">√ó</span>
        </div>
        <div id="historyList">
            </div>
    </div>
</div>

<script>
    // --- Gƒ∞Rƒ∞≈û ƒ∞≈ûLEMLERƒ∞ ---
    const CREDENTIALS = { user: "ihlas", pass: "1234" };

    function checkLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const remember = document.getElementById('rememberMe').checked;
        const errorDiv = document.getElementById('loginError');

        if (u === CREDENTIALS.user && p === CREDENTIALS.pass) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            if (remember) localStorage.setItem('isLoggedIn', 'true');
            initializeApp();
        } else {
            errorDiv.style.display = 'block';
        }
    }

    function logout() {
        localStorage.removeItem('isLoggedIn');
        location.reload();
    }

    function checkSession() {
        if (localStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            initializeApp();
        }
    }

    // --- KARANLIK MOD ---
    function toggleDarkMode() {
        const body = document.body;
        const icon = document.getElementById('themeIcon');
        
        if (body.getAttribute('data-theme') === 'dark') {
            body.setAttribute('data-theme', 'light');
            icon.textContent = 'üåô';
            localStorage.setItem('theme', 'light');
        } else {
            body.setAttribute('data-theme', 'dark');
            icon.textContent = '‚òÄÔ∏è';
            localStorage.setItem('theme', 'dark');
        }
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
        }
    }

    // --- HESAPLAMA KURALLARI ---
    const RULES = {
        24000: 2, 24500: 2,
        26000: 5, 27000: 5,
        28000: 8, 29000: 8,
        30000: 13, 
        31000: 13, 
        32000: 16, 33000: 16,
        34000: 19, 35000: 19,
        36000: 21, 
        37500: 13,
        43500: 5,
        50500: 10,
        55000: 13,
        63000: 2, 70000: 6,
        75000: 9, 80000: 13, 84000: 16
    };

    const KLIMA_RULES = {
        31000: 5,
        36000: 10
    };

    function formatNum(num) { return num.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    
    function diffDays(d1, d2) {
        if(!d1 || !d2) return 0;
        const date1 = new Date(d1);
        const date2 = new Date(d2);
        const diffTime = date2 - date1;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    }

    function addMonths(dateStr, months) {
        let d = new Date(dateStr);
        d.setMonth(d.getMonth() + months);
        if (d.getDate() !== new Date(dateStr).getDate()) d.setDate(0);
        return d.toISOString().split('T')[0];
    }

    function getNextMonthFirstDay(baseDateStr) {
        let d = new Date(baseDateStr);
        d.setMonth(d.getMonth() + 1); 
        d.setDate(1);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        return `${year}-${month}-01`;
    }

    function toggleKlima() {
        generateTargetPlan();
    }

    function generateTargetPlan() {
        const ciroInput = parseFloat(document.getElementById('targetCiro').value);
        const refDate = document.getElementById('satisTarihi').value;
        const isKlima = document.getElementById('klimaMode').checked;
        const tbody = document.querySelector('#tableLeft tbody');
        const warningEl = document.getElementById('ciroWarning');
        const klimaBadge = document.getElementById('klimaIndicator');
        const istisnaiLabel = document.getElementById('istisnaiLabel');

        if(isKlima) {
            istisnaiLabel.classList.add('label-active');
        } else {
            istisnaiLabel.classList.remove('label-active');
        }
        
        tbody.innerHTML = ""; 
        klimaBadge.style.display = 'none';

        let installmentCount = 0;

        if (ciroInput) {
            if (isKlima && KLIMA_RULES[ciroInput]) {
                installmentCount = KLIMA_RULES[ciroInput];
                klimaBadge.style.display = 'inline-block';
            } 
            else if (RULES[ciroInput]) {
                installmentCount = RULES[ciroInput];
            }
        }

        if (!ciroInput || !refDate || installmentCount === 0) {
            document.getElementById('leftCiro').textContent = "0,00";
            document.getElementById('leftGunTutar').textContent = "0,00";
            document.getElementById('leftAvg').textContent = "0,00";
            calculateFinalResult(); 
            if(ciroInput && installmentCount === 0) warningEl.style.display = 'block';
            else warningEl.style.display = 'none';
            return;
        }
        warningEl.style.display = 'none';

        const baseAmount = ciroInput / installmentCount;
        let currentTotal = 0;

        for (let i = 0; i < installmentCount; i++) {
            let amount = parseFloat(baseAmount.toFixed(2));
            if (i === installmentCount - 1) amount = ciroInput - currentTotal;
            currentTotal += amount;

            const vadeDate = (i === 0) ? refDate : addMonths(refDate, i);
            const gun = diffDays(refDate, vadeDate);
            const gunTutar = amount * gun;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center; font-weight:bold; color:#777;">${i+1}</td>
                <td><input type="text" class="input-tutar readonly-input" value="${formatNum(amount)}" readonly></td>
                <td><input type="date" class="input-vade readonly-input" value="${vadeDate}" readonly></td>
                <td class="cell-gun" style="text-align:center;">${gun}</td>
                <td class="cell-gun-tutar" style="text-align:right; font-size:12px;">${formatNum(gunTutar)}</td>
            `;
            tbody.appendChild(tr);
        }
        calculateSummary('tableLeft', 'leftCiro', 'leftGunTutar', 'leftAvg', true);
    }

    function updateRowNumbers() {
        const rows = document.querySelectorAll('#tableRight tbody tr');
        rows.forEach((row, index) => {
            const numCell = row.querySelector('.row-num');
            if (index === 0) {
                if(numCell) numCell.textContent = "-"; 
                row.classList.add('first-row');
            } else {
                if(numCell) numCell.textContent = index; 
                row.classList.remove('first-row');
            }
        });
    }

    function copyTargetToReal() {
        const leftRows = document.querySelectorAll('#tableLeft tbody tr');
        if (leftRows.length === 0) {
            alert("Kopyalanacak hedef tablo bo≈ü! √ñnce ciro giriniz.");
            return;
        }

        const rightTbody = document.querySelector('#tableRight tbody');
        rightTbody.innerHTML = "";

        leftRows.forEach((row, index) => {
            const amountValStr = row.querySelector('.input-tutar').value;
            const amountRaw = parseFloat(amountValStr.replace(/\./g, '').replace(',', '.'));
            const dateVal = row.querySelector('.input-vade').value;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center;"><button class="btn-delete" onclick="deleteRow(this)">‚úï</button></td>
                <td class="row-num" style="text-align:center; font-weight:bold; color:#555;"></td>
                <td style="position:relative;">
                    <div class="input-wrapper">
                        <span class="pesinat-badge">PE≈ûƒ∞NAT</span>
                        <input type="number" class="input-tutar" value="${amountRaw.toFixed(2)}" step="0.01" oninput="calculateRightSide()">
                    </div>
                </td>
                <td><input type="date" class="input-vade" value="${dateVal}" onchange="calculateRightSide()"></td>
                <td class="cell-gun" style="text-align:center; color:var(--text-color);">0</td>
                <td class="cell-gun-tutar" style="text-align:right; color:var(--text-color); font-size:12px;">0,00</td>
            `;
            rightTbody.appendChild(tr);
        });

        updateRowNumbers();
        calculateRightSide();
    }
    
    function createRightRow(amount, dateVal, tbody) {
         const tr = document.createElement('tr');
         tr.innerHTML = `
            <td style="text-align:center;"><button class="btn-delete" onclick="deleteRow(this)">‚úï</button></td>
            <td class="row-num" style="text-align:center; font-weight:bold; color:#555;"></td>
            <td style="position:relative;">
                <div class="input-wrapper">
                    <span class="pesinat-badge">PE≈ûƒ∞NAT</span>
                    <input type="number" class="input-tutar" value="${amount.toFixed(2)}" step="0.01" oninput="calculateRightSide()">
                </div>
            </td>
            <td><input type="date" class="input-vade" value="${dateVal}" onchange="calculateRightSide()"></td>
            <td class="cell-gun" style="text-align:center; color:var(--text-color);">0</td>
            <td class="cell-gun-tutar" style="text-align:right; color:var(--text-color); font-size:12px;">0,00</td>
        `;
        tbody.appendChild(tr);
    }

    function addManualRow() {
        const tbody = document.querySelector('#tableRight tbody');
        const rows = tbody.querySelectorAll('tr');
        const refDate = document.getElementById('satisTarihi').value;
        let targetDate;
        if (rows.length === 0) {
            targetDate = refDate;
        } else {
            const lastInput = rows[rows.length - 1].querySelector('.input-vade');
            const baseDate = (lastInput && lastInput.value) ? lastInput.value : refDate;
            targetDate = getNextMonthFirstDay(baseDate);
        }
        createRightRow(0, targetDate, tbody);
        updateRowNumbers();
        calculateRightSide();
    }

    function deleteRow(btn) {
        btn.closest('tr').remove();
        updateRowNumbers();
        calculateRightSide();
    }

    function clearRightTable() {
        document.querySelector('#tableRight tbody').innerHTML = "";
        calculateRightSide();
    }

    function calculateRightSide() {
        calculateSummary('tableRight', 'rightCiro', 'rightGunTutar', 'rightAvg', false);
    }

    function calculateSummary(tblId, ciroId, gtId, avgId, isLocked) {
        const st = document.getElementById('satisTarihi').value;
        let totCiro = 0, totGT = 0;
        
        document.querySelectorAll(`#${tblId} tbody tr`).forEach(row => {
            let tutar = 0;
            if (isLocked) {
                const rawVal = row.querySelector('.input-tutar').value; 
                tutar = parseFloat(rawVal.replace(/\./g, '').replace(',', '.'));
            } else {
                tutar = parseFloat(row.querySelector('.input-tutar').value) || 0;
            }
            const vade = row.querySelector('.input-vade').value;
            const gun = (st && vade) ? diffDays(st, vade) : 0;
            const gt = tutar * gun;
            
            row.querySelector('.cell-gun').textContent = gun;
            row.querySelector('.cell-gun-tutar').textContent = formatNum(gt);
            totCiro += tutar;
            totGT += gt;
        });
        
        document.getElementById(ciroId).textContent = formatNum(totCiro);
        document.getElementById(gtId).textContent = formatNum(totGT);
        let avg = totCiro > 0.1 ? totGT / totCiro : 0;
        document.getElementById(avgId).textContent = formatNum(avg);
        calculateFinalResult();
    }

    function calculateFinalResult() {
        const parseTr = (id) => parseFloat(document.getElementById(id).textContent.replace(/\./g, '').replace(',', '.')) || 0;
        const leftAvg = parseTr('leftAvg');
        const rightAvg = parseTr('rightAvg');
        const leftCiro = parseTr('leftCiro');
        const rightCiro = parseTr('rightCiro');

        // --- Cƒ∞RO E≈ûƒ∞TLƒ∞K KONTROL√ú ---
        const targetInputVal = parseFloat(document.getElementById('targetCiro').value) || 0;
        const msgEl = document.getElementById('ciroStatusMsg');
        const rightCiroEl = document.getElementById('rightCiro');

        if (Math.abs(targetInputVal - rightCiro) > 0.1) {
            msgEl.style.display = 'block';
            rightCiroEl.style.color = '#d32f2f';
        } else {
            msgEl.style.display = 'none';
            rightCiroEl.style.color = 'var(--text-color)';
        }

        if (leftCiro === 0) {
            document.getElementById('finalSapma').textContent = "0,00";
            updateRiskBar(0, false);
            return;
        }

        const sapma = rightAvg - leftAvg;
        const el = document.getElementById('finalSapma');
        el.textContent = formatNum(sapma);
        updateRiskBar(sapma, true);
    }

    function updateRiskBar(sapma, isActive) {
        const bar = document.getElementById('riskBar');
        const txt = document.getElementById('riskText');
        const box = document.getElementById('finalSapma');

        if (!isActive) {
            bar.style.width = '0%';
            txt.textContent = 'VERƒ∞ BEKLENƒ∞YOR...';
            txt.style.color = '#999';
            box.style.backgroundColor = '#bdbdbd';
            box.style.color = '#fff';
            return;
        }

        let color, width, text, textColor, boxTextColor = '#fff';

        if (sapma <= 0) {
            color = '#2e7d32'; width = '100%'; text = "G√úVENLƒ∞ (≈ûƒ∞RKET LEHƒ∞NE)"; textColor = '#2e7d32';
        } else if (sapma <= 15) {
            color = '#66bb6a'; width = '50%'; text = "MAKUL SEVƒ∞YE"; textColor = '#66bb6a';
        } else if (sapma <= 25) {
            color = '#fdd835'; width = '66%'; text = "Dƒ∞KKAT EDƒ∞LMELƒ∞"; textColor = '#f9a825'; boxTextColor = '#333';
        } else if (sapma < 29) {
            color = '#ff9800'; width = '85%'; text = "Rƒ∞SKLƒ∞ B√ñLGE"; textColor = '#ef6c00';
        } else {
            color = '#d32f2f'; width = '100%'; text = "KRƒ∞Tƒ∞K Rƒ∞SK!"; textColor = '#c62828';
        }

        bar.style.width = width;
        bar.style.backgroundColor = color;
        txt.textContent = text;
        txt.style.color = textColor;
        box.style.backgroundColor = color;
        box.style.color = boxTextColor;
    }

    // --- GE√áMƒ∞≈û KAYIT VE Y√úKLEME ---
    function saveSimulation() {
        const ciro = document.getElementById('targetCiro').value;
        if(!ciro) { alert("Kaydetmek i√ßin √∂nce ciro girmelisiniz."); return; }
        
        const name = prompt("Bu hesaplama i√ßin bir isim girin:", `${ciro} TL - Hesaplama`);
        if(!name) return;

        const rightRows = [];
        document.querySelectorAll('#tableRight tbody tr').forEach(row => {
             const tutar = row.querySelector('.input-tutar').value;
             const vade = row.querySelector('.input-vade').value;
             rightRows.push({tutar, vade});
        });

        const data = {
            id: Date.now(),
            name: name,
            date: new Date().toLocaleString(),
            ciro: ciro,
            refDate: document.getElementById('satisTarihi').value,
            klima: document.getElementById('klimaMode').checked,
            rows: rightRows
        };

        const history = JSON.parse(localStorage.getItem('calcHistory') || "[]");
        history.unshift(data);
        localStorage.setItem('calcHistory', JSON.stringify(history));
        alert("Kayƒ±t ba≈üarƒ±lƒ±!");
    }

    function showHistory() {
        const history = JSON.parse(localStorage.getItem('calcHistory') || "[]");
        const list = document.getElementById('historyList');
        list.innerHTML = "";

        if(history.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:#999;'>Kayƒ±tlƒ± hesaplama yok.</p>";
        } else {
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold;">${item.name}</div>
                        <div class="history-info">${item.ciro} TL | ${item.klima ? '‚ùÑÔ∏è Klima' : 'Standart'}</div>
                        <div class="history-date">${item.date}</div>
                    </div>
                    <div>
                        <button class="btn-restore" onclick="restoreSimulation(${item.id})">Y√ºkle</button>
                        <button class="btn-del-hist" onclick="deleteSimulation(${item.id})">Sil</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        document.getElementById('historyModal').style.display = 'block';
    }

    function restoreSimulation(id) {
        const history = JSON.parse(localStorage.getItem('calcHistory') || "[]");
        const item = history.find(x => x.id === id);
        if(!item) return;

        document.getElementById('targetCiro').value = item.ciro;
        document.getElementById('satisTarihi').value = item.refDate;
        document.getElementById('klimaMode').checked = item.klima;

        generateTargetPlan();

        const rightTbody = document.querySelector('#tableRight tbody');
        rightTbody.innerHTML = "";
        item.rows.forEach(row => {
            createRightRow(parseFloat(row.tutar), row.vade, rightTbody);
        });
        
        updateRowNumbers();
        calculateRightSide();
        closeHistory();
    }

    function deleteSimulation(id) {
        if(!confirm("Silmek istediƒüinize emin misiniz?")) return;
        let history = JSON.parse(localStorage.getItem('calcHistory') || "[]");
        history = history.filter(x => x.id !== id);
        localStorage.setItem('calcHistory', JSON.stringify(history));
        showHistory();
    }

    function closeHistory() {
        document.getElementById('historyModal').style.display = 'none';
    }

    // --- PDF ƒ∞NDƒ∞RME ---
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text("Vade Sapmasi Analizi", 14, 20);
        
        doc.setFontSize(11);
        const tarih = new Date().toLocaleDateString('tr-TR');
        doc.text(`Rapor Tarihi: ${tarih}`, 14, 28);
        
        const ciro = document.getElementById('targetCiro').value;
        const sapma = document.getElementById('finalSapma').textContent;
        const refTarih = document.getElementById('satisTarihi').value;
        
        doc.text(`Fatura Tutari: ${ciro} TL`, 14, 35);
        doc.text(`Ref Tarihi: ${refTarih}`, 80, 35);
        doc.text(`Vade Sapmasi: ${sapma} Gun`, 14, 42);
        
        const headLeft = [['No', 'Tutar', 'Vade', 'Gun', 'Carpan']];
        const bodyLeft = [];
        document.querySelectorAll('#tableLeft tbody tr').forEach(tr => {
            const tds = tr.querySelectorAll('td');
            bodyLeft.push([
                tds[0].textContent,
                tr.querySelector('.input-tutar').value,
                tr.querySelector('.input-vade').value,
                tds[3].textContent,
                tds[4].textContent
            ]);
        });

        const headRight = [['No', 'Tutar', 'Vade', 'Gun', 'Carpan']];
        const bodyRight = [];
        document.querySelectorAll('#tableRight tbody tr').forEach(tr => {
            const rowNum = tr.querySelector('.row-num').textContent;
            const tutar = tr.querySelector('.input-tutar').value;
            const vade = tr.querySelector('.input-vade').value;
            const gun = tr.querySelector('.cell-gun').textContent;
            const carpan = tr.querySelector('.cell-gun-tutar').textContent;
            bodyRight.push([rowNum === '-' ? 'Pesinat' : rowNum, tutar, vade, gun, carpan]);
        });

        doc.setFontSize(12);
        doc.setTextColor(40);
        doc.text("Hedef Plan (Olmasi Gereken)", 14, 55);
        
        doc.autoTable({
            head: headLeft,
            body: bodyLeft,
            startY: 60,
            theme: 'striped',
            styles: { fontSize: 9 }
        });

        doc.text("Gerceklesen Odeme Plani", 14, doc.lastAutoTable.finalY + 10);
        
        doc.autoTable({
            head: headRight,
            body: bodyRight,
            startY: doc.lastAutoTable.finalY + 15,
            theme: 'grid',
            styles: { fontSize: 9 }
        });

        const finalY = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text("Bu rapor By_Oguz yazilimi tarafindan olusturulmustur.", 14, finalY);
        
        doc.save(`Vade_Analizi_${ciro}.pdf`);
    }

    function initializeApp() {
        loadTheme();
        const dateInput = document.getElementById('satisTarihi');
        if(!dateInput.value) dateInput.valueAsDate = new Date();
        generateTargetPlan();
        calculateRightSide();
    }

    window.onload = function() {
        checkSession();

        document.getElementById('targetCiro').addEventListener('input', generateTargetPlan);
        document.getElementById('satisTarihi').addEventListener('change', () => {
            generateTargetPlan();
            calculateRightSide();
        });
        
        document.getElementById('password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') checkLogin();
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    };
</script>
</body>
</html>
