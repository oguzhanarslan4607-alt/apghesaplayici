<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vade Sapma Analizi</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --bg:#f4f7f6; --txt:#333; --panel:#fff; --inp:#fff; --brd:#e0e0e0; --th:#f8f9fa; --primary: #4a90e2; --accent: #00acc1; }
        [data-theme="dark"] { --bg:#121212; --txt:#e0e0e0; --panel:#1e1e1e; --inp:#2c2c2c; --brd:#444; --th:#252525; --primary: #1565c0; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); 
            color: var(--txt); 
            margin: 0; 
            padding: 10px;
            padding-bottom: 80px; 
            -webkit-tap-highlight-color: transparent;
        }
        *, *:before, *:after { box-sizing: border-box; }

        /* Login Ekranƒ± */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4a90e2, #0056b3); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; }
        .login-btn { width: 100%; padding: 15px; background: #4a90e2; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }

        #app-container { display: none; max-width: 1280px; margin: 0 auto; }
        
        /* √úst Butonlar */
        .header-actions { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; margin-bottom: 15px; }
        .action-group { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .btn { 
            padding: 10px 15px;
            border-radius: 8px; 
            border: 1px solid var(--brd); 
            background: var(--panel); 
            color: var(--txt); 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-red { background: #ff5252; color: white; border: none; }

        /* Filtre Alanƒ± */
        .top-bar { 
            background: var(--panel);
            padding: 15px; 
            border-radius: 12px; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; 
            margin-bottom: 20px; 
            border: 1px solid var(--brd);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .input-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 6px; color: var(--txt); opacity: 0.7; letter-spacing: 0.5px; }
        .top-bar input { 
            width: 100%;
            padding: 12px;
            border-radius: 8px; 
            border: 2px solid var(--brd); 
            background: var(--inp); 
            color: var(--txt); 
            font-weight: 600; 
            text-align: center; 
            font-size: 15px;
        }
        #targetCiro { background: #e3f2fd; color: #0d47a1; border-color: #bbdefb; }
        [data-theme="dark"] #targetCiro { background: #1a237e; color: #bbdefb; border-color: #304ffe; }

        /* Klima Checkbox */
        .klima-wrapper { 
            display: flex;
            align-items: center; justify-content: center; 
            background: rgba(0, 172, 193, 0.1); 
            height: 46px; 
            border-radius: 8px; 
            cursor: pointer;
            border: 1px solid rgba(0, 172, 193, 0.3); 
            transition: all 0.3s;
        }
        .klima-wrapper label { margin: 0 0 0 10px; cursor: pointer; color: #00838f; font-weight: bold; font-size: 14px; }
        [data-theme="dark"] .klima-wrapper label { color: #80cbc4; }
        .label-active { color: #00acc1 !important; }

        /* Ana Panel */
        .main-wrapper { display: flex; gap: 15px; flex-wrap: wrap; }
        .panel { 
            flex: 1;
            background: var(--panel); 
            border-radius: 12px; 
            border: 1px solid var(--brd); 
            overflow: hidden; 
            min-width: 300px;
            display: flex; 
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .panel h3 { margin: 0; padding: 15px; text-align: center; color: white; font-size: 14px; position: relative; letter-spacing: 0.5px; }
        .panel-left h3 { background: linear-gradient(to right, #4a90e2, #357abd); } 
        .panel-right h3 { background: linear-gradient(to right, #66bb6a, #43a047); }
        .klima-badge { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: white; color: #006064; padding: 3px 8px; border-radius: 4px; font-size: 10px; display: none; font-weight: 900; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Tablolar */
        .table-container { 
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; 
            max-height: 50vh; 
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 350px; }
        th { background: var(--th); color: var(--txt); padding: 12px 8px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--brd); font-weight: 600; font-size: 12px; }
        td { padding: 6px; border-bottom: 1px solid var(--brd); }
        
        input.tbl-inp { 
            width: 100%;
            padding: 10px;
            border: 1px solid var(--brd); 
            border-radius: 6px; 
            background: var(--inp); 
            color: var(--txt); 
            text-align: center; 
            font-size: 14px; 
            font-weight: 500;
        }
        input.tbl-inp:focus { outline: 2px solid var(--primary); border-color: transparent; }
        .money { text-align: right; font-weight: 600; letter-spacing: 0.5px; }
        .readonly { background: rgba(0,0,0,0.03) !important; pointer-events: none; border: none; }
        [data-theme="dark"] .readonly { background: rgba(255,255,255,0.05) !important; }

        .pesinat-badge { position: absolute; top: -16px; left: 2px; font-size: 9px; background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px 4px 0 0; display: none; font-weight: bold; }
        tr.first-row .pesinat-badge { display: block; }
        tr.first-row td { padding-top: 15px; }
        .btn-delete { background: #ffebee; color: #c62828; border: none; width: 24px; height: 24px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .btn-row { display: flex; gap: 8px; padding: 12px; background: var(--th); border-top: 1px solid var(--brd); }
        .btn-act { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--brd); background: var(--panel); color: var(--txt); cursor: pointer; font-weight: bold; font-size: 13px; box-shadow: 0 2px 2px rgba(0,0,0,0.05); }
        .btn-copy { flex: 1.5; background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }
        [data-theme="dark"] .btn-copy { background: #0d47a1; color: #bbdefb; border-color: #1565c0; }

        .summary { background: var(--th); padding: 15px; border-top: 1px solid var(--brd); font-size: 14px; }
        .sum-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-weight: bold; }
        .avg { color: var(--primary); border-top: 1px dashed var(--brd); padding-top: 8px; margin-top: 8px; font-size: 15px; }

        /* Sonu√ß Alanƒ± */
        .result-area { margin-top: 20px; background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--brd); text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .result-flex { display: flex; justify-content: space-between; align-items: center; gap: 20px; flex-wrap: wrap-reverse; }
        .result-info { text-align: left; font-size: 13px; opacity: 0.85; flex: 2; min-width: 200px; line-height: 1.5; }
        .sapma-box { font-size: 32px; font-weight: 800; padding: 15px 25px; border-radius: 12px; color: white; display: inline-block; min-width: 140px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .risk-bar-bg { width: 100%; height: 16px; background: var(--bg); border-radius: 8px; margin-top: 20px; overflow: hidden; border: 1px solid var(--brd); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .risk-bar-fill { height: 100%; width: 0%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }

        .disclaimer { background: #fff8e1; border-left: 5px solid #ffb300; padding: 15px; margin-top: 20px; border-radius: 8px; font-size: 13px; color: #5d4037; line-height: 1.6; }
        [data-theme="dark"] .disclaimer { background: #3e2723; color: #ffe0b2; border-color: #ff6f00; }
        
        .footer { text-align: center; margin-top: 30px; padding: 20px; opacity: 0.7; font-size: 12px; }
        .maras { background: linear-gradient(to right, #b71c1c, #ffc107, #b71c1c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: block; margin-bottom: 5px; font-weight: 900; font-size: 14px; animation: shine 3s linear infinite; background-size: 200%; }
        @keyframes shine { to { background-position: 200% center; } }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .modal-content { background: var(--panel); margin: 15vh auto; padding: 20px; width: 90%; max-width: 450px; border-radius: 15px; max-height: 70vh; overflow-y: auto; border: 1px solid var(--brd); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hist-item { padding: 15px 10px; border-bottom: 1px solid var(--brd); display: flex; justify-content: space-between; align-items: center; }

        /* TOAST (Bildirim) Stili */
        #toast { 
            visibility: hidden;
            min-width: 250px; 
            background-color: #323232; 
            color: #fff; 
            text-align: center; 
            border-radius: 8px; 
            padding: 16px; 
            position: fixed; 
            z-index: 3000; 
            left: 50%; 
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .toast-success { border-left: 6px solid #4caf50; }
        .toast-error { border-left: 6px solid #f44336; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .main-wrapper { flex-direction: column; }
            .panel { width: 100%; }
            .top-bar { grid-template-columns: 1fr 1fr; gap: 10px; }
            .input-group:nth-child(3) { grid-column: span 2; }
            .input-group:nth-child(4) { grid-column: span 2; }
            .header-actions { flex-direction: column; gap: 10px; }
            .header-actions .btn-red { width: 100%; }
            .action-group { display: grid; grid-template-columns: 1fr 1fr; width: 100%; }
            .result-flex { flex-direction: column-reverse; text-align: center; }
            .result-info { text-align: center; width: 100%; }
            table { font-size: 14px; }
            input.tbl-inp { font-size: 14px; padding: 12px 5px; }

            /* MOBIL D√úZENLEME: Kutucuklarƒ± geni≈ületme */
            .table-container td input.money { min-width: 120px !important; }
            .table-container td input[type="date"] { min-width: 110px !important; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color:#333; margin-bottom:20px;">Giri≈ü Yap</h2>
        <input type="text" id="username" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±" value="ihlas">
        <input type="password" id="password" class="login-input" placeholder="≈ûifre">
        <div id="loginError" style="color:#e53935; display:none; margin-bottom:15px; font-weight:bold;">Hatalƒ± Giri≈ü!</div>
        <button class="login-btn" onclick="checkLogin()">Gƒ∞Rƒ∞≈û YAP</button>
    </div>
</div>

<div id="toast">Bildirim Mesajƒ±</div>

<div id="app-container">
    <div class="header-actions">
        <button class="btn btn-red" onclick="logout()">üîê √áƒ±kƒ±≈ü Yap</button>
        <div class="action-group">
            <button class="btn" onclick="toggleTheme()">üåó Tema</button>
            <button class="btn" onclick="showHistory()">üìÅ Ge√ßmi≈ü</button>
            <button class="btn" onclick="saveData()">üíæ Kaydet</button>
            <button class="btn" onclick="exportPDF()">üìÑ PDF</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="input-group">
            <label>FATURA TARƒ∞Hƒ∞</label>
            <input type="date" id="satisTarihi">
        </div>
        <div class="input-group">
            <label>Cƒ∞RO</label>
            <input type="number" id="targetCiro" placeholder="Tutar Giriniz" inputmode="decimal">
        </div>
        <div class="input-group">
            <label>SENET ADEDƒ∞</label>
            <input type="number" id="senetCount" placeholder="Taksit Sayƒ±sƒ±" oninput="createAutoTable()" inputmode="numeric">
        </div>
        <div class="input-group">
            <label id="lblKlima">ƒ∞STƒ∞SNAƒ∞ DURUM</label>
            <div class="klima-wrapper" onclick="toggleKlima()">
                <input type="checkbox" id="klimaMode" style="width:20px; height:20px; margin:0;">
                <label for="klimaMode">‚ùÑÔ∏è KLƒ∞MA</label>
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="panel panel-left">
            <h3>üéØ OLMASI GEREKEN <span id="badgeKlima" class="klima-badge">KLƒ∞MA</span></h3>
            <div class="table-container">
                <table id="tblLeft">
                    <thead><tr><th style="width:40px">No</th><th>Tutar</th><th>Vade</th><th style="width:50px">G√ºn</th><th>√áarpan</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="summary">
                <div class="sum-row"><span>Toplam Ciro:</span><span id="sumLeftCiro">0,00</span></div>
                <div class="sum-row avg"><span>Ortalama Vade:</span><span id="sumLeftAvg">0,00</span></div>
            </div>
        </div>

        <div class="panel panel-right">
            <h3>üìù GER√áEKLE≈ûEN (OLAN)</h3>
            <div class="table-container">
                <table id="tblRight">
                    <thead><tr><th style="width:40px">Sil</th><th style="width:30px">No</th><th>Tutar</th><th>Vade</th><th style="width:40px">Gn</th><th>√áarpan</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="btn-row">
                <button class="btn-act btn-copy" onclick="copyTable()">‚ö° Kopyala</button>
                <button class="btn-act" onclick="addEmptyRow()">+ Ekle</button>
                <button class="btn-act" onclick="clearTable()" style="color:#e53935; border-color:#e53935;">üóëÔ∏è Temizle</button>
            </div>
            <div class="summary">
                <div class="sum-row"><span>Toplam Ciro:</span><span id="sumRightCiro">0,00</span></div>
                <div id="msgDiff" style="color:#d32f2f; font-weight:bold; font-size:12px; text-align:right; display:none; margin-bottom:5px;">‚ö†Ô∏è Tutarlar E≈üit Deƒüil!</div>
                <div class="sum-row avg"><span>Ortalama Vade:</span><span id="sumRightAvg">0,00</span></div>
            </div>
        </div>
    </div>

    <div class="result-area">
        <div class="result-flex">
            <div class="result-info">
                <div style="margin-bottom:10px;"><strong>üí° Taktik:</strong> Apg oranƒ± denemesi yaparken; satƒ±≈ü tarihini her ayƒ±n son g√ºn√º, ilk senet tarihini her ayƒ±n ilk g√ºn√º yapmanƒ±z taktirde vade tarihleri kƒ±salacaktƒ±r.</div>
                <div><strong>‚ö° ƒ∞pucu:</strong> Sol tabloyu saƒüa hƒ±zlƒ±ca aktarmak i√ßin <b>"Kopyala"</b> butonunu kullanƒ±n.</div>
            </div>
            <div style="text-align:center; flex:1;">
                <div style="font-weight:bold; margin-bottom:8px; font-size:14px; opacity:0.7; letter-spacing:1px;">VADE SAPMASI</div>
                <div id="finalSapma" class="sapma-box" style="background:#bdbdbd;">0,00</div>
            </div>
        </div>
        <div class="risk-bar-bg"><div id="riskBar" class="risk-bar-fill"></div></div>
        <div id="riskText" style="font-size:13px; font-weight:800; margin-top:8px; opacity:0.8; letter-spacing:1px;">VERƒ∞ BEKLENƒ∞YOR...</div>
    </div>

    <div class="disclaimer">
        <h4 style="margin:0 0 10px 0;">‚ö†Ô∏è √ñNEMLƒ∞ NOT</h4>
        <p style="margin-top:0;">Payla≈üƒ±lan veriler ve hesaplamalar, Merkez tarafƒ±ndan belirlenen mevcut vade sapmasƒ± oranlarƒ± baz alƒ±narak hazƒ±rlanmƒ±≈ütƒ±r.</p>
        <ul style="margin:0; padding-left:20px;">
            <li style="margin-bottom:5px;">Merkez oranlarƒ±nda herhangi bir g√ºncelleme yapƒ±lmasƒ± durumunda, l√ºtfen <strong>Muhasebe Departmanƒ±</strong> ile irtibata ge√ßiniz.</li>
            <li style="margin-bottom:5px;">Verileri kullanƒ±rken g√ºncelliƒüini teyit etmeniz ve deƒüi≈üen ko≈üullara kar≈üƒ± dikkatli olmanƒ±z √∂nem arz etmektedir.</li>
            <li style="margin-bottom:5px;"><strong>Vade Sapmasƒ± oranƒ± 29'un altƒ±na d√º≈üerse</strong> satƒ±≈üƒ±n girme olasƒ±lƒ±ƒüƒ± istisnai durumlar haricinde vardƒ±r.</li>
        </ul>
    </div>

    <div class="footer">
        <span class="maras">üå∂Ô∏è Bƒ∞R KAHRAMANMARA≈û YAPIMIDIR üå∂Ô∏è</span>
        <span>By_Oƒüuz &copy; 2026</span>
    </div>
</div>

<div id="modalHist" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid var(--brd); padding-bottom:10px;">
            <h3 style="margin:0;">Kayƒ±tlƒ± Hesaplamalar</h3>
            <span onclick="document.getElementById('modalHist').style.display='none'" style="cursor:pointer; font-size:24px; line-height:20px;">&times;</span>
        </div>
        <div id="histList"></div>
    </div>
</div>

<div id="modalSave" class="modal">
    <div class="modal-content" style="max-width:350px;">
        <h3 style="margin-top:0;">Hesaplamayƒ± Kaydet</h3>
        <p style="font-size:13px; color:#666; margin-bottom:15px;">Bu hesaplamayƒ± daha sonra tekrar a√ßmak i√ßin bir isim veriniz.</p>
        <input type="text" id="saveNameInput" class="login-input" placeholder="√ñrn: M√º≈üteri ABC">
        <div style="display:flex; gap:10px; margin-top:5px;">
            <button class="btn" style="flex:1;" onclick="document.getElementById('modalSave').style.display='none'">ƒ∞ptal</button>
            <button class="btn btn-copy" style="flex:1;" onclick="confirmSave()">üíæ KAYDET</button>
        </div>
    </div>
</div>

<script>
    // --- AYARLAR ---
    const USER = "ihlas", PASS = "1234";
    const RULES = { 24000:2, 24500:2, 26000:5, 27000:5, 28000:8, 29000:8, 30000:13, 31000:13, 32000:16, 33000:16, 34000:19, 35000:19, 36000:21, 37500:13, 43500:5, 50500:10, 55000:13, 63000:2, 70000:6, 75000:9, 80000:13, 84000:16 };
    
    // G√úNCEL KLƒ∞MA APG KURALLARI (Sadece belirtilen yeni baremler i≈ülendi)
    const K_RULES = { 
        // 12 BTU Klima Fiyatlarƒ± ve Oranlarƒ±
        31000: 2,   // 1+1
        35900: 5,   // 1+4
        43000: 10,  // 1+9
        48600: 13,  // 1+12

        // 18 BTU Klima Fiyatlarƒ± ve Oranlarƒ±
        42500: 2,   // 1+1
        49000: 5,   // 1+4
        58900: 10,  // 1+9
        66500: 13   // 1+12
    };

    // --- YARDIMCILAR ---
    const fmt = n => n.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
    const prs = s => parseFloat(String(s).replace(/\./g,'').replace(',','.')) || 0;
    const diff = (d1,d2) => (!d1||!d2)?0:Math.ceil((new Date(d2)-new Date(d1))/(864e5));
    function addM(d,m) { let x=new Date(d); x.setMonth(x.getMonth()+m); if(x.getDate()!==new Date(d).getDate()) x.setDate(0); return x.toISOString().split('T')[0]; }
    function nextMonthFirst(d) { let x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(1); return x.toISOString().split('T')[0]; }

    // --- TOAST Sƒ∞STEMƒ∞ ---
    function showToast(msg, type='success') {
        const t = document.getElementById("toast");
        t.innerHTML = (type==='error'?'‚ö†Ô∏è ':'‚úÖ ') + msg;
        t.className = "show " + (type==='error'?'toast-error':'toast-success');
        setTimeout(function(){ t.className = t.className.replace("show", ""); }, 3000);
    }

    // --- Gƒ∞Rƒ∞≈û ---
    function checkLogin() {
        if(document.getElementById('username').value===USER && document.getElementById('password').value===PASS) {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-container').style.display='block';
            localStorage.setItem('logged','1');
            init();
        } else { document.getElementById('loginError').style.display='block'; }
    }
    function logout() { localStorage.removeItem('logged'); location.reload(); }
    function toggleTheme() {
        let b=document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')==='dark'?'light':'dark');
        localStorage.setItem('theme', b.getAttribute('data-theme'));
    }

    // --- SOL TABLO MANTIƒûI ---
    function calcLeft() {
        const ciro = parseFloat(document.getElementById('targetCiro').value) || 0;
        const date = document.getElementById('satisTarihi').value;
        const klima = document.getElementById('klimaMode').checked;
        const tbody = document.querySelector('#tblLeft tbody');
        
        const lbl = document.getElementById('lblKlima');
        if(klima) lbl.classList.add('label-active'); else lbl.classList.remove('label-active');
        
        tbody.innerHTML = ""; 
        
        let count = 0;
        if(ciro>0) {
            if(klima && K_RULES[ciro]) { count = K_RULES[ciro]; document.getElementById('badgeKlima').style.display='inline-block'; }
            else if(RULES[ciro]) { count = RULES[ciro]; document.getElementById('badgeKlima').style.display='none'; }
        }

        if(count === 0 || !date) { summarize('tblLeft', 'sumLeftCiro', 'sumLeftAvg', true); return; }

        let base = ciro / count;
        let tot = 0;
        let html = "";

        for(let i=0; i<count; i++) {
            let amt = (i===count-1) ? ciro - tot : parseFloat(base.toFixed(2));
            tot += amt;
            let d = (i===0) ? date : addM(date, i);
            let days = diff(date, d);
            let gt = amt * days;
            html += `<tr>
                <td style="text-align:center; color:#777; font-weight:bold;">${i+1}</td>
                <td><input class="tbl-inp money readonly" value="${fmt(amt)}"></td>
                <td><input class="tbl-inp readonly" value="${d}"></td>
                <td style="text-align:center;">${days}</td>
                <td style="text-align:right; font-size:12px;">${fmt(gt)}</td>
            </tr>`;
        }
        tbody.innerHTML = html;
        summarize('tblLeft', 'sumLeftCiro', 'sumLeftAvg', true);
    }

    // --- SAƒû TABLO ---
    function createAutoTable() {
        const cnt = parseInt(document.getElementById('senetCount').value) || 0;
        const date = document.getElementById('satisTarihi').value;
        const tbody = document.querySelector('#tblRight tbody');
        
        tbody.innerHTML = "";
        if(cnt<=0 || !date) { calcRight(); return; }

        addRightRow(0, date, "P≈ûN");
        let nextD = nextMonthFirst(date);
        for(let i=1; i<=cnt; i++) {
            addRightRow(i, nextD, i);
            let d = new Date(nextD); d.setMonth(d.getMonth()+1);
            nextD = d.toISOString().split('T')[0];
        }
        renumberRight();
        calcRight();
    }

    function addRightRow(idx, dateVal, lbl) {
        const tbody = document.querySelector('#tblRight tbody');
        const badge = idx===0 ? '<span class="pesinat-badge">PE≈ûƒ∞NAT</span>' : '';
        const tr = document.createElement('tr');
        if(idx===0) tr.classList.add('first-row');
        tr.innerHTML = `
            <td style="text-align:center;"><button class="btn-delete" onclick="delRow(this)">‚úï</button></td>
            <td class="r-num" style="text-align:center; font-weight:bold; color:#555;">${lbl}</td>
            <td style="position:relative;"><div class="input-wrapper" style="position:relative">${badge}<input type="number" class="tbl-inp money" value="0" step="0.01" oninput="syncAmt(this)"></div></td>
            <td><input type="date" class="tbl-inp" value="${dateVal}" onchange="syncDate(this)"></td>
            <td class="g-day" style="text-align:center;">0</td>
            <td class="g-tot" style="text-align:right; font-size:12px;">0,00</td>
        `;
        tbody.appendChild(tr);
    }

    function syncAmt(el) {
        const tr = el.closest('tr');
        const all = document.querySelectorAll('#tblRight tbody tr');
        let idx = -1; all.forEach((r, i) => { if(r===tr) idx=i; });
        if(idx > 0) { 
            let val = el.value;
            for(let i = idx + 1; i < all.length; i++) {
                all[i].querySelector('input[type=number]').value = val;
            }
        }
        calcRight();
    }

    function syncDate(el) {
        const tr = el.closest('tr');
        const all = document.querySelectorAll('#tblRight tbody tr');
        let idx = -1; all.forEach((r, i) => { if(r===tr) idx=i; });
        let curr = el.value;
        for(let i=idx+1; i<all.length; i++) {
            let d = new Date(curr);
            d.setMonth(d.getMonth()+1); d.setDate(1);
            let s = d.toISOString().split('T')[0];
            all[i].querySelector('input[type=date]').value = s;
            curr = s;
        }
        calcRight();
    }

    function addEmptyRow() {
        const all = document.querySelectorAll('#tblRight tbody tr');
        const ref = document.getElementById('satisTarihi').value;
        let d = ref;
        if(all.length>0) {
            let last = all[all.length-1].querySelector('input[type=date]').value;
            let ld = new Date(last); ld.setMonth(ld.getMonth()+1); ld.setDate(1);
            d = ld.toISOString().split('T')[0];
        }
        addRightRow(all.length, d, all.length===0?"P≈ûN":all.length);
        renumberRight(); calcRight();
    }
    
    function delRow(btn) { btn.closest('tr').remove(); renumberRight(); calcRight(); }
    function clearTable() { document.querySelector('#tblRight tbody').innerHTML=""; calcRight(); }
    
    function renumberRight() {
        document.querySelectorAll('#tblRight tbody tr').forEach((r,i)=>{
            r.querySelector('.r-num').textContent = i===0 ? "P≈ûN" : i;
            if(i===0) r.classList.add('first-row'); else r.classList.remove('first-row');
            let w = r.querySelector('.input-wrapper');
            let b = w.querySelector('.pesinat-badge');
            if(i===0 && !b) w.insertAdjacentHTML('afterbegin', '<span class="pesinat-badge">PE≈ûƒ∞NAT</span>');
            if(i!==0 && b) b.remove();
        });
    }

    function copyTable() {
        const src = document.querySelectorAll('#tblLeft tbody tr');
        if(src.length===0) return showToast("Hedef tablo bo≈ü!", "error");
        const dest = document.querySelector('#tblRight tbody');
        dest.innerHTML = "";
        src.forEach((r,i)=>{
            let amt = prs(r.querySelector('input').value); 
            let dat = r.querySelectorAll('input')[1].value; 
            addRightRow(i, dat, i===0?"P≈ûN":i);
            dest.lastElementChild.querySelector('input[type=number]').value = amt.toFixed(2);
        });
        calcRight();
    }

    function calcRight() { summarize('tblRight', 'sumRightCiro', 'sumRightAvg', false); }

    function summarize(tblId, ciroId, avgId, isLocked) {
        const date = document.getElementById('satisTarihi').value;
        let tCiro=0, tGt=0;
        document.querySelectorAll(`#${tblId} tbody tr`).forEach(r => {
            let inps = r.querySelectorAll('input');
            let val = isLocked ? prs(inps[0].value) : (parseFloat(inps[0].value)||0);
            let d = inps[1].value;
            let days = diff(date, d);
            let gt = val * days;
            if(!isLocked) {
                r.querySelector('.g-day').textContent = days;
                r.querySelector('.g-tot').textContent = fmt(gt);
            }
            tCiro += val; tGt += gt;
        });
        document.getElementById(ciroId).textContent = fmt(tCiro);
        let avg = tCiro>0 ? tGt/tCiro : 0;
        document.getElementById(avgId).textContent = fmt(avg);
        if(!isLocked) updateResult();
    }

    function updateResult() {
        let lAvg = prs(document.getElementById('sumLeftAvg').textContent);
        let rAvg = prs(document.getElementById('sumRightAvg').textContent);
        let sapma = rAvg - lAvg;
        let tCiro = parseFloat(document.getElementById('targetCiro').value)||0;
        let rCiro = prs(document.getElementById('sumRightCiro').textContent);
        let msg = document.getElementById('msgDiff');
        if(Math.abs(tCiro-rCiro)>0.1) msg.style.display='block'; else msg.style.display='none';

        let box = document.getElementById('finalSapma');
        let bar = document.getElementById('riskBar');
        let txt = document.getElementById('riskText');
        if(lAvg===0 && rCiro===0) {
            box.textContent = "0,00"; box.style.background="#bdbdbd";
            bar.style.width="0%";
            txt.textContent="VERƒ∞ BEKLENƒ∞YOR...";
            return;
        }

        box.textContent = fmt(sapma);
        let col, w, t;
        if(sapma<=0) { col='#2e7d32'; w='100%'; t="G√úVENLƒ∞ (0 ve altƒ±)"; }
        else if(sapma<=15) { col='#66bb6a'; w='50%'; t="MAKUL (0 - 15)"; }
        else if(sapma<=25) { col='#fdd835'; w='66%'; t="Dƒ∞KKAT (15 - 25)"; }
        else if(sapma<29) { col='#ff9800'; w='85%'; t="Rƒ∞SKLƒ∞ (25 - 29)"; }
        else if(sapma<30) { col='#d32f2f'; w='95%'; t="KRƒ∞Tƒ∞K (29 - 30)"; }
        else { col='#8b0000'; w='100%'; t="Gƒ∞RMEZ (30+)"; }
        
        box.style.background = col;
        box.style.color = (col==='#fdd835'?'#333':'#fff');
        bar.style.background = col; bar.style.width = w;
        txt.textContent = t; txt.style.color = (col==='#fdd835'?'#f9a825':col);
    }

    function toggleKlima() {
        let chk = document.getElementById('klimaMode');
        if(event.target.tagName!=='INPUT') chk.checked = !chk.checked;
        calcLeft();
    }

    function saveData() {
        let ciro = document.getElementById('targetCiro').value;
        if(!ciro) return showToast("√ñnce bir Ciro girmelisiniz!", "error");
        let existing = document.querySelectorAll('#tblRight tbody tr').length;
        if(existing === 0) return showToast("Kaydedilecek saƒü tablo verisi yok.", "error");
        document.getElementById('saveNameInput').value = fmt(parseFloat(ciro)) + " TL Satƒ±≈ü";
        document.getElementById('modalSave').style.display = 'block';
    }

    function confirmSave() {
        let name = document.getElementById('saveNameInput').value;
        if(!name) return showToast("L√ºtfen bir isim girin.", "error");
        let ciro = document.getElementById('targetCiro').value;
        let h = JSON.parse(localStorage.getItem('hist')||"[]");
        let rows = [];
        document.querySelectorAll('#tblRight tbody tr').forEach(r=>{
            rows.push({ t: r.querySelector('input[type=number]').value, d: r.querySelector('input[type=date]').value });
        });
        h.unshift({id:Date.now(), name, ciro, date:new Date().toLocaleDateString(), rows});
        localStorage.setItem('hist', JSON.stringify(h));
        document.getElementById('modalSave').style.display = 'none';
        showToast("Ba≈üarƒ±yla Kaydedildi!");
    }
    
    function showHistory() {
        let h = JSON.parse(localStorage.getItem('hist')||"[]");
        let d = document.getElementById('histList'); d.innerHTML="";
        if(h.length === 0) d.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Hen√ºz kayƒ±t yok.</div>";
        h.forEach(x => {
            d.innerHTML += `
            <div class="hist-item">
                <div>
                    <div style="font-weight:bold; font-size:14px;">${x.name}</div>
                    <small style="color:#777;">${x.date} - ${fmt(parseFloat(x.ciro))} TL</small>
                </div>
                <div>
                    <button class="btn" style="padding:5px 10px; font-size:12px;" onclick="loadH(${x.id})">Y√ºkle</button>
                    <button class="btn btn-red" style="padding:5px 10px; font-size:12px; margin-left:5px;" onclick="delH(${x.id})">Sil</button>
                </div>
            </div>`;
        });
        document.getElementById('modalHist').style.display='block';
    }
    
    function loadH(id) {
        let h = JSON.parse(localStorage.getItem('hist')).find(a=>a.id==id);
        document.getElementById('targetCiro').value = h.ciro;
        calcLeft();
        let tb = document.querySelector('#tblRight tbody'); tb.innerHTML="";
        h.rows.forEach((r,i)=> { addRightRow(i, r.d, i===0?"P≈ûN":i); tb.lastElementChild.querySelector('input[type=number]').value=r.t; });
        calcRight();
        document.getElementById('modalHist').style.display='none';
        showToast("Kayƒ±t y√ºklendi.");
    }

    function delH(id) {
        if(!confirm("Bu kaydƒ± silmek istediƒüinize emin misiniz?")) return;
        let h = JSON.parse(localStorage.getItem('hist')).filter(a=>a.id!=id);
        localStorage.setItem('hist', JSON.stringify(h));
        showHistory();
        showToast("Kayƒ±t silindi.", "error");
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont("helvetica", "bold");
        doc.text("Vade Sapmasi Analiz Raporu", 14, 20);
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        let info = `Tarih: ${new Date().toLocaleDateString()} | Ciro: ${document.getElementById('targetCiro').value}`;
        doc.text(info, 14, 28);

        function getTableData(tableId, skipFirstCol) {
            let rows = [];
            document.querySelectorAll(tableId + ' tbody tr').forEach(tr => {
                let rowData = [];
                let cells = tr.querySelectorAll('td');
                let start = skipFirstCol ? 1 : 0;
                for(let i=start; i<cells.length; i++) {
                    let cell = cells[i];
                    let input = cell.querySelector('input');
                    if(input) { rowData.push(input.value); } 
                    else { rowData.push(cell.innerText.trim()); }
                }
                rows.push(rowData);
            });
            return rows;
        }

        doc.autoTable({
            head: [['No', 'Tutar', 'Vade', 'Gun', 'Carpan']],
            body: getTableData('#tblLeft', false),
            startY: 35,
            theme: 'grid',
            headStyles: { fillColor: [74, 144, 226] }
        });
        doc.text("Gerceklesen Tablo (Sag)", 14, doc.lastAutoTable.finalY + 10);
        doc.autoTable({
            head: [['No', 'Tutar', 'Vade', 'Gun', 'Carpan']],
            body: getTableData('#tblRight', true),
            startY: doc.lastAutoTable.finalY + 15,
            theme: 'grid',
            headStyles: { fillColor: [102, 187, 106] }
        });

        let sapma = document.getElementById('finalSapma').textContent;
        doc.setFontSize(14);
        doc.text(`Sonuc Vade Sapmasi: ${sapma}`, 14, doc.lastAutoTable.finalY + 20);
        doc.save('vade-sapmasi-analiz.pdf');
    }

    function init() {
        if(localStorage.getItem('theme')==='dark') document.body.setAttribute('data-theme','dark');
        let d = document.getElementById('satisTarihi');
        if(!d.value) d.valueAsDate = new Date();
        calcLeft(); calcRight();
    }

    window.onload = function() {
        if(localStorage.getItem('logged')) {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-container').style.display='block';
            init();
        }
        document.getElementById('targetCiro').addEventListener('input', calcLeft);
        document.getElementById('satisTarihi').addEventListener('change', function() {
            let newVal = this.value;
            let rightRows = document.querySelectorAll('#tblRight tbody tr');
            if(rightRows.length > 0) {
                let pDateInput = rightRows[0].querySelector('input[type=date]');
                if(pDateInput) {
                    pDateInput.value = newVal;
                    syncDate(pDateInput);
                }
            }
            calcLeft(); 
            calcRight();
        });
    }
</script>
</body>
</html>
