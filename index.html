<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vade SapmasÄ± Analizi (Final)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --bg:#f4f7f6; --txt:#333; --panel:#fff; --inp:#fff; --brd:#e0e0e0; --th:#f8f9fa; }
        [data-theme="dark"] { --bg:#121212; --txt:#e0e0e0; --panel:#1e1e1e; --inp:#2c2c2c; --brd:#444; --th:#252525; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--txt); margin: 0; padding: 20px; padding-bottom: 80px; }
        *, *:before, *:after { box-sizing: border-box; }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4a90e2, #0056b3); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #eee; border-radius: 8px; }
        .login-btn { width: 100%; padding: 12px; background: #4a90e2; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        #app-container { display: none; max-width: 1280px; margin: 0 auto; }
        
        .header-actions { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--brd); background: var(--panel); color: var(--txt); cursor: pointer; font-weight: bold; }
        .btn:hover { background: #e3f2fd; color: #1565c0; }
        .btn-red { background: #ff5252; color: white; border: none; }

        .top-bar { background: var(--panel); padding: 15px; border-radius: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 20px; border: 1px solid var(--brd); }
        .input-group { flex: 1; min-width: 150px; }
        .input-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: var(--txt); opacity: 0.8; }
        .top-bar input { width: 100%; padding: 10px; border-radius: 6px; border: 2px solid var(--brd); background: var(--inp); color: var(--txt); font-weight: bold; text-align: center; }
        #targetCiro { background: #e3f2fd; color: #0d47a1; }
        [data-theme="dark"] #targetCiro { background: #1a237e; color: #bbdefb; }

        .klima-wrapper { display: flex; align-items: center; justify-content: center; background: #e0f7fa; padding: 0 15px; height: 40px; border-radius: 6px; cursor: pointer; border: 1px solid #b2ebf2; }
        [data-theme="dark"] .klima-wrapper { background: #004d40; border-color: #00695c; }
        .klima-wrapper label { margin: 0 0 0 8px; cursor: pointer; color: #006064; font-weight: bold; font-size: 14px; opacity: 1; }
        [data-theme="dark"] .klima-wrapper label { color: #80cbc4; }
        .label-active { color: #00acc1 !important; text-shadow: 0 0 5px rgba(0,172,193,0.4); }

        .main-wrapper { display: flex; gap: 20px; flex-wrap: wrap; }
        .panel { flex: 1; background: var(--panel); border-radius: 12px; border: 1px solid var(--brd); overflow: hidden; min-width: 350px; display: flex; flex-direction: column; }
        .panel h3 { margin: 0; padding: 12px; text-align: center; color: white; font-size: 14px; position: relative; }
        .panel-left h3 { background: #4a90e2; } .panel-right h3 { background: #66bb6a; }
        .klima-badge { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: white; color: #006064; padding: 2px 6px; border-radius: 4px; font-size: 10px; display: none; font-weight: 900; }

        .table-container { overflow-x: auto; max-height: 450px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: var(--th); color: var(--txt); padding: 10px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--brd); }
        td { padding: 5px; border-bottom: 1px solid var(--brd); }
        input.tbl-inp { width: 100%; padding: 6px; border: 1px solid var(--brd); border-radius: 4px; background: var(--inp); color: var(--txt); text-align: center; }
        .money { text-align: right; font-weight: 600; }
        .readonly { background: var(--bg) !important; pointer-events: none; }

        .pesinat-badge { position: absolute; top: -18px; left: 0; font-size: 9px; background: #ff9800; color: white; padding: 1px 5px; border-radius: 3px; display: none; font-weight: bold; }
        tr.first-row .pesinat-badge { display: block; }
        tr.first-row td { padding-top: 15px; }

        .btn-row { display: flex; gap: 5px; padding: 10px; }
        .btn-act { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--brd); background: var(--bg); color: var(--txt); cursor: pointer; font-weight: bold; }
        .btn-copy { flex: 2; background: #e3f2fd; color: #1565c0; border-color: #90caf9; }
        [data-theme="dark"] .btn-copy { background: #0d47a1; color: #bbdefb; border-color: #1565c0; }

        .summary { background: var(--th); padding: 10px; border-top: 1px solid var(--brd); font-size: 13px; margin-top: auto; }
        .sum-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: bold; }
        .avg { color: #4a90e2; border-top: 1px solid var(--brd); padding-top: 5px; margin-top: 5px; }

        .result-area { margin-top: 20px; background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--brd); text-align: center; }
        .sapma-box { font-size: 28px; font-weight: 800; padding: 10px 30px; border-radius: 8px; color: white; display: inline-block; min-width: 120px; }
        .risk-bar-bg { width: 100%; height: 12px; background: var(--bg); border-radius: 6px; margin-top: 15px; overflow: hidden; border: 1px solid var(--brd); }
        .risk-bar-fill { height: 100%; width: 0%; transition: 0.5s; }

        .disclaimer { background: #fff8e1; border-left: 5px solid #ffb300; padding: 15px; margin-top: 20px; border-radius: 6px; font-size: 13px; color: #5d4037; }
        [data-theme="dark"] .disclaimer { background: #3e2723; color: #ffe0b2; border-color: #ff6f00; }
        
        .footer { text-align: center; margin-top: 40px; padding: 20px; border-top: 1px dashed var(--brd); font-weight: bold; }
        .maras { background: linear-gradient(to right, #b71c1c, #ffc107, #b71c1c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: block; margin-bottom: 5px; animation: shine 3s linear infinite; background-size: 200%; }
        @keyframes shine { to { background-position: 200% center; } }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background: var(--panel); margin: 10% auto; padding: 20px; width: 90%; max-width: 450px; border-radius: 10px; max-height: 70vh; overflow-y: auto; border: 1px solid var(--brd); }
        .hist-item { padding: 10px; border-bottom: 1px solid var(--brd); display: flex; justify-content: space-between; align-items: center; }

        @media (max-width: 768px) { .main-wrapper { flex-direction: column; } }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>GiriÅŸ Yap</h2>
        <input type="text" id="username" class="login-input" placeholder="KullanÄ±cÄ± AdÄ±" value="ihlas">
        <input type="password" id="password" class="login-input" placeholder="Åifre">
        <div id="loginError" style="color:red; display:none; margin-bottom:10px;">HatalÄ± GiriÅŸ!</div>
        <button class="login-btn" onclick="checkLogin()">GÄ°RÄ°Å</button>
    </div>
</div>

<div id="app-container">
    <div class="header-actions">
        <button class="btn btn-red" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
        <div style="display:flex; gap:5px;">
            <button class="btn" onclick="toggleTheme()">ğŸŒ™/â˜€ï¸</button>
            <button class="btn" onclick="showHistory()">ğŸ“ GeÃ§miÅŸ</button>
            <button class="btn" onclick="saveData()">ğŸ’¾ Kaydet</button>
            <button class="btn" onclick="exportPDF()">ğŸ“„ PDF</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="input-group">
            <label>FATURA TARÄ°HÄ°</label>
            <input type="date" id="satisTarihi">
        </div>
        <div class="input-group">
            <label>CÄ°RO</label>
            <input type="number" id="targetCiro" placeholder="Ã–rn: 34000">
        </div>
        <div class="input-group">
            <label>SENET ADEDÄ°</label>
            <input type="number" id="senetCount" placeholder="Adet" oninput="createAutoTable()">
        </div>
        <div class="input-group" style="min-width: 140px;">
            <label id="lblKlima">Ä°STÄ°SNAÄ° FÄ°YAT</label>
            <div class="klima-wrapper" onclick="toggleKlima()">
                <input type="checkbox" id="klimaMode">
                <label for="klimaMode">â„ï¸ KLÄ°MA</label>
            </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="panel panel-left">
            <h3>OLMASI GEREKEN (HEDEF) <span id="badgeKlima" class="klima-badge">KLÄ°MA</span></h3>
            <div class="table-container">
                <table id="tblLeft">
                    <thead><tr><th>No</th><th>Tutar</th><th>Vade</th><th>GÃ¼n</th><th>Ã‡arpan</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="summary">
                <div class="sum-row"><span>Toplam:</span><span id="sumLeftCiro">0,00</span></div>
                <div class="sum-row avg"><span>Ort. Vade:</span><span id="sumLeftAvg">0,00</span></div>
            </div>
        </div>

        <div class="panel panel-right">
            <h3>GERÃ‡EKLEÅEN (OLAN)</h3>
            <div class="table-container">
                <table id="tblRight">
                    <thead><tr><th style="width:30px">Sil</th><th style="width:30px">No</th><th>Tutar</th><th>Vade</th><th>GÃ¼n</th><th>Ã‡arpan</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="btn-row">
                <button class="btn-act btn-copy" onclick="copyTable()">âš¡ Kopyala</button>
                <button class="btn-act" onclick="addEmptyRow()">+ Ekle</button>
                <button class="btn-act" onclick="clearTable()">Temizle</button>
            </div>
            <div class="summary">
                <div class="sum-row"><span>Toplam:</span><span id="sumRightCiro">0,00</span></div>
                <div id="msgDiff" style="color:red; font-weight:bold; font-size:11px; text-align:right; display:none;">âš ï¸ EÅŸit DeÄŸil!</div>
                <div class="sum-row avg"><span>Ort. Vade:</span><span id="sumRightAvg">0,00</span></div>
            </div>
        </div>
    </div>

    <div class="result-area">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <div style="text-align:left; font-size:12px; opacity:0.8; flex:1;">
                <div style="margin-bottom:5px;"><strong>ğŸ’¡ Taktik:</strong> Apg oranÄ± denemesi yaparken; satÄ±ÅŸ tarihini her ayÄ±n son gÃ¼nÃ¼, ilk senet tarihini her ayÄ±n ilk gÃ¼nÃ¼ yapmanÄ±z taktirde vade tarihleri kÄ±salacaÄŸÄ± iÃ§in satÄ±ÅŸÄ±nÄ±zÄ±n girme olasÄ±lÄ±k ihtimali artacaktÄ±r.</div>
                <div><strong>âš¡ Ä°pucu:</strong> Sol tabloyu saÄŸa aktarmak iÃ§in <b>"Kopyala"</b> butonunu kullanÄ±n.</div>
            </div>
            <div style="text-align:center;">
                <div style="font-weight:bold; margin-bottom:5px;">VADE SAPMASI</div>
                <div id="finalSapma" class="sapma-box" style="background:#bdbdbd;">0,00</div>
            </div>
        </div>
        <div class="risk-bar-bg"><div id="riskBar" class="risk-bar-fill"></div></div>
        <div id="riskText" style="font-size:11px; font-weight:bold; margin-top:5px; opacity:0.7;">VERÄ° BEKLENÄ°YOR...</div>
    </div>

    <div class="disclaimer">
        <h4>âš ï¸ Ã–NEMLÄ° NOT</h4>
        <p>PaylaÅŸÄ±lan veriler ve hesaplamalar, Merkez tarafÄ±ndan belirlenen mevcut vade sapmasÄ± oranlarÄ± baz alÄ±narak hazÄ±rlanmÄ±ÅŸtÄ±r.</p>
        <ul>
            <li>Merkez oranlarÄ±nda herhangi bir gÃ¼ncelleme yapÄ±lmasÄ± durumunda, lÃ¼tfen <strong>Muhasebe DepartmanÄ±</strong> ile irtibata geÃ§iniz.</li>
            <li>Verileri kullanÄ±rken gÃ¼ncelliÄŸini teyit etmeniz ve deÄŸiÅŸen koÅŸullara karÅŸÄ± dikkatli olmanÄ±z Ã¶nem arz etmektedir.</li>
            <li><strong>Vade SapmasÄ± oranÄ± 29'un altÄ±na dÃ¼ÅŸerse</strong> satÄ±ÅŸÄ±n girme olasÄ±lÄ±ÄŸÄ± istisnai durumlar haricinde vardÄ±r.</li>
        </ul>
    </div>

    <div class="footer">
        <span class="maras">ğŸŒ¶ï¸ BÄ°R KAHRAMANMARAÅ YAPIMIDIR ğŸŒ¶ï¸</span>
        <span>By_OÄŸuz</span>
    </div>
</div>

<div id="modalHist" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid var(--brd); padding-bottom:5px;">
            <h3>KayÄ±tlar</h3><span onclick="document.getElementById('modalHist').style.display='none'" style="cursor:pointer; font-size:20px;">Ã—</span>
        </div>
        <div id="histList"></div>
    </div>
</div>

<script>
    // --- AYARLAR ---
    const USER = "ihlas", PASS = "1234";
    const RULES = { 24000:2, 24500:2, 26000:5, 27000:5, 28000:8, 29000:8, 30000:13, 31000:13, 32000:16, 33000:16, 34000:19, 35000:19, 36000:21, 37500:13, 43500:5, 50500:10, 55000:13, 63000:2, 70000:6, 75000:9, 80000:13, 84000:16 };
    const K_RULES = { 31000:5, 36000:10 };

    // --- YARDIMCILAR ---
    const fmt = n => n.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
    const prs = s => parseFloat(String(s).replace(/\./g,'').replace(',','.')) || 0;
    const diff = (d1,d2) => (!d1||!d2)?0:Math.ceil((new Date(d2)-new Date(d1))/(864e5));
    
    function addM(d,m) { let x=new Date(d); x.setMonth(x.getMonth()+m); if(x.getDate()!==new Date(d).getDate()) x.setDate(0); return x.toISOString().split('T')[0]; }
    
    // Bir sonraki ayÄ±n 1'i
    function nextMonthFirst(d) { let x=new Date(d); x.setMonth(x.getMonth()+1); x.setDate(1); return x.toISOString().split('T')[0]; }

    // --- GÄ°RÄ°Å ---
    function checkLogin() {
        if(document.getElementById('username').value===USER && document.getElementById('password').value===PASS) {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-container').style.display='block';
            localStorage.setItem('logged','1');
            init();
        } else { document.getElementById('loginError').style.display='block'; }
    }
    function logout() { localStorage.removeItem('logged'); location.reload(); }
    function toggleTheme() {
        let b=document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')==='dark'?'light':'dark');
        localStorage.setItem('theme', b.getAttribute('data-theme'));
    }

    // --- SOL TABLO MANTIÄI (ESKÄ° HALÄ°NE DÃ–NDÃœRÃœLDÃœ) ---
    function calcLeft() {
        const ciro = parseFloat(document.getElementById('targetCiro').value) || 0;
        const date = document.getElementById('satisTarihi').value;
        const klima = document.getElementById('klimaMode').checked;
        const tbody = document.querySelector('#tblLeft tbody');
        
        // Etiketleri yÃ¶net
        const lbl = document.getElementById('lblKlima');
        if(klima) lbl.classList.add('label-active'); else lbl.classList.remove('label-active');
        
        tbody.innerHTML = ""; // Temizle
        
        // Taksit sayÄ±sÄ± bul
        let count = 0;
        if(ciro>0) {
            if(klima && K_RULES[ciro]) { count = K_RULES[ciro]; document.getElementById('badgeKlima').style.display='inline-block'; }
            else if(RULES[ciro]) { count = RULES[ciro]; document.getElementById('badgeKlima').style.display='none'; }
        }

        if(count === 0 || !date) {
             // EÄŸer ciro var ama kural yoksa sÄ±fÄ±rla
             summarize('tblLeft', 'sumLeftCiro', 'sumLeftAvg', true);
             return;
        }

        // SatÄ±rlarÄ± oluÅŸtur (innerHTML YÃ¶ntemiyle - HATA Ã‡IKARMAZ)
        let base = ciro / count;
        let tot = 0;
        let html = "";

        for(let i=0; i<count; i++) {
            let amt = (i===count-1) ? ciro - tot : parseFloat(base.toFixed(2));
            tot += amt;
            let d = (i===0) ? date : addM(date, i);
            let days = diff(date, d);
            let gt = amt * days;
            
            html += `
            <tr>
                <td style="text-align:center; color:#777; font-weight:bold;">${i+1}</td>
                <td><input class="tbl-inp money readonly" value="${fmt(amt)}"></td>
                <td><input class="tbl-inp readonly" value="${d}"></td>
                <td style="text-align:center;">${days}</td>
                <td style="text-align:right; font-size:12px;">${fmt(gt)}</td>
            </tr>`;
        }
        tbody.innerHTML = html;
        summarize('tblLeft', 'sumLeftCiro', 'sumLeftAvg', true);
    }

    // --- SAÄ TABLO OTOMATÄ°K OLUÅTURMA ---
    function createAutoTable() {
        const cnt = parseInt(document.getElementById('senetCount').value) || 0;
        const date = document.getElementById('satisTarihi').value;
        const tbody = document.querySelector('#tblRight tbody');
        
        tbody.innerHTML = "";
        if(cnt<=0 || !date) { calcRight(); return; }

        // 1. PeÅŸinat (SatÄ±ÅŸ Tarihi)
        addRightRow(0, date, "PEÅÄ°NAT");

        // 2. Senetler (Bir sonraki ayÄ±n 1'inden baÅŸla)
        let nextD = nextMonthFirst(date);
        for(let i=1; i<=cnt; i++) {
            addRightRow(i, nextD, i);
            // Sonraki dÃ¶ngÃ¼ iÃ§in 1 ay ekle (ayÄ±n 1'i korunur)
            let d = new Date(nextD); d.setMonth(d.getMonth()+1);
            nextD = d.toISOString().split('T')[0];
        }
        renumberRight();
        calcRight();
    }

    // --- SAÄ TABLO YARDIMCILARI ---
    function addRightRow(idx, dateVal, lbl) {
        const tbody = document.querySelector('#tblRight tbody');
        const badge = idx===0 ? '<span class="pesinat-badge">PEÅÄ°NAT</span>' : '';
        
        // innerHTML ile ekle
        const tr = document.createElement('tr');
        if(idx===0) tr.classList.add('first-row');
        
        tr.innerHTML = `
            <td style="text-align:center;"><button class="btn-delete" onclick="delRow(this)">âœ•</button></td>
            <td class="r-num" style="text-align:center; font-weight:bold; color:#555;">${lbl}</td>
            <td style="position:relative;">
                <div class="input-wrapper">
                    ${badge}
                    <input type="number" class="tbl-inp money" value="0" step="0.01" oninput="syncAmt(this)">
                </div>
            </td>
            <td><input type="date" class="tbl-inp" value="${dateVal}" onchange="syncDate(this)"></td>
            <td class="g-day" style="text-align:center;">0</td>
            <td class="g-tot" style="text-align:right; font-size:12px;">0,00</td>
        `;
        tbody.appendChild(tr);
    }

    // Tutar EÅŸitleme: 1. Senet (Index 1) deÄŸiÅŸirse diÄŸerlerini gÃ¼ncelle
    function syncAmt(el) {
        const tr = el.closest('tr');
        const all = document.querySelectorAll('#tblRight tbody tr');
        // Index bul
        let idx = -1; 
        all.forEach((r, i) => { if(r===tr) idx=i; });

        if(idx === 1) { // PeÅŸinattan sonraki ilk senet
            let val = el.value;
            for(let i=2; i<all.length; i++) {
                all[i].querySelector('input[type=number]').value = val;
            }
        }
        calcRight();
    }

    // Tarih Zincirleme: DeÄŸiÅŸen tarihten sonrakileri 1 ay Ã¶tele (ayÄ±n 1'i yap)
    function syncDate(el) {
        const tr = el.closest('tr');
        const all = document.querySelectorAll('#tblRight tbody tr');
        let idx = -1; all.forEach((r, i) => { if(r===tr) idx=i; });
        
        let curr = el.value;
        for(let i=idx+1; i<all.length; i++) {
            let d = new Date(curr); d.setMonth(d.getMonth()+1); d.setDate(1);
            let s = d.toISOString().split('T')[0];
            all[i].querySelector('input[type=date]').value = s;
            curr = s;
        }
        calcRight();
    }

    function addEmptyRow() {
        const all = document.querySelectorAll('#tblRight tbody tr');
        const ref = document.getElementById('satisTarihi').value;
        let d = ref;
        if(all.length>0) {
            let last = all[all.length-1].querySelector('input[type=date]').value;
            let ld = new Date(last); ld.setMonth(ld.getMonth()+1); ld.setDate(1);
            d = ld.toISOString().split('T')[0];
        }
        addRightRow(all.length, d, all.length===0?"PEÅÄ°NAT":all.length);
        renumberRight(); calcRight();
    }
    
    function delRow(btn) { btn.closest('tr').remove(); renumberRight(); calcRight(); }
    function clearTable() { document.querySelector('#tblRight tbody').innerHTML=""; calcRight(); }
    
    function renumberRight() {
        document.querySelectorAll('#tblRight tbody tr').forEach((r,i)=>{
            r.querySelector('.r-num').textContent = i===0 ? "PEÅÄ°NAT" : i;
            if(i===0) r.classList.add('first-row'); else r.classList.remove('first-row');
            // Badge yÃ¶netimi
            let w = r.querySelector('.input-wrapper');
            let b = w.querySelector('.pesinat-badge');
            if(i===0 && !b) w.insertAdjacentHTML('afterbegin', '<span class="pesinat-badge">PEÅÄ°NAT</span>');
            if(i!==0 && b) b.remove();
        });
    }

    function copyTable() {
        const src = document.querySelectorAll('#tblLeft tbody tr');
        if(src.length===0) return alert("Hedef tablo boÅŸ!");
        const dest = document.querySelector('#tblRight tbody');
        dest.innerHTML = "";
        src.forEach((r,i)=>{
            let amt = prs(r.querySelector('input').value); // Ä°lk input tutar
            let dat = r.querySelectorAll('input')[1].value; // Ä°kinci input vade
            addRightRow(i, dat, i===0?"PEÅÄ°NAT":i);
            dest.lastElementChild.querySelector('input[type=number]').value = amt.toFixed(2);
        });
        calcRight();
    }

    // --- HESAPLAMA & SONUÃ‡ ---
    function calcRight() { summarize('tblRight', 'sumRightCiro', 'sumRightAvg', false); }

    function summarize(tblId, ciroId, avgId, isLocked) {
        const date = document.getElementById('satisTarihi').value;
        let tCiro=0, tGt=0;
        
        document.querySelectorAll(`#${tblId} tbody tr`).forEach(r => {
            let inps = r.querySelectorAll('input');
            let val = isLocked ? prs(inps[0].value) : (parseFloat(inps[0].value)||0);
            let d = inps[1].value;
            let days = diff(date, d);
            let gt = val * days;
            
            // HÃ¼creleri gÃ¼ncelle (eÄŸer varsa) - Sol tabloda input yok td var
            if(isLocked) {
                // Sol tabloda statik olduÄŸu iÃ§in gÃ¼ncellemeye gerek yok, zaten dÃ¶ngÃ¼de yazÄ±ldÄ±.
                // Sadece toplamÄ± al.
            } else {
                // SaÄŸ tablo
                r.querySelector('.g-day').textContent = days;
                r.querySelector('.g-tot').textContent = fmt(gt);
            }
            
            tCiro += val; tGt += gt;
        });

        document.getElementById(ciroId).textContent = fmt(tCiro);
        let avg = tCiro>0 ? tGt/tCiro : 0;
        document.getElementById(avgId).textContent = fmt(avg);
        
        if(!isLocked) updateResult();
    }

    function updateResult() {
        let lAvg = prs(document.getElementById('sumLeftAvg').textContent);
        let rAvg = prs(document.getElementById('sumRightAvg').textContent);
        let sapma = rAvg - lAvg;
        
        // Ciro kontrol
        let tCiro = parseFloat(document.getElementById('targetCiro').value)||0;
        let rCiro = prs(document.getElementById('sumRightCiro').textContent);
        let msg = document.getElementById('msgDiff');
        if(Math.abs(tCiro-rCiro)>0.1) msg.style.display='block'; else msg.style.display='none';

        let box = document.getElementById('finalSapma');
        let bar = document.getElementById('riskBar');
        let txt = document.getElementById('riskText');
        
        if(lAvg===0 && rCiro===0) {
            box.textContent = "0,00"; box.style.background="#bdbdbd";
            bar.style.width="0%"; txt.textContent="VERÄ° BEKLENÄ°YOR...";
            return;
        }

        box.textContent = fmt(sapma);
        
        let col, w, t, tc="#fff";
        if(sapma<=0) { col='#2e7d32'; w='100%'; t="GÃœVENLÄ°"; }
        else if(sapma<=15) { col='#66bb6a'; w='50%'; t="MAKUL"; }
        else if(sapma<=25) { col='#fdd835'; w='66%'; t="DÄ°KKAT"; tc="#333"; }
        else if(sapma<29) { col='#ff9800'; w='85%'; t="RÄ°SKLÄ°"; }
        else { col='#d32f2f'; w='100%'; t="KRÄ°TÄ°K"; }

        box.style.background = col; box.style.color = (col==='#fdd835'?'#333':'#fff');
        bar.style.background = col; bar.style.width = w;
        txt.textContent = t; txt.style.color = (col==='#fdd835'?'#f9a825':col);
    }

    // --- EKSTRALAR ---
    function toggleKlima() {
        let chk = document.getElementById('klimaMode');
        // Wrapper click
        if(event.target.tagName!=='INPUT') chk.checked = !chk.checked;
        calcLeft();
    }

    function save() {
        // Basit kayÄ±t
        let name = prompt("KayÄ±t AdÄ±:");
        if(!name) return;
        // ... (Ã–nceki mantÄ±kla aynÄ±)
        alert("Kaydedildi (Demo)");
    }
    
    // Basit localStorage geÃ§miÅŸi (Ã–nceki koddan alÄ±nabilir, yer tutmamasÄ± iÃ§in kÄ±salttÄ±m)
    function saveData() {
        let ciro = document.getElementById('targetCiro').value;
        if(!ciro) return alert("Ciro girin");
        let name = prompt("Ä°sim:", ciro + " TL");
        if(!name) return;
        let h = JSON.parse(localStorage.getItem('hist')||"[]");
        
        let rows = [];
        document.querySelectorAll('#tblRight tbody tr').forEach(r=>{
            rows.push({ t: r.querySelector('input[type=number]').value, d: r.querySelector('input[type=date]').value });
        });
        
        h.unshift({id:Date.now(), name, ciro, date:new Date().toLocaleDateString(), rows});
        localStorage.setItem('hist', JSON.stringify(h));
        alert("Tamam");
    }
    
    function showHistory() {
        let h = JSON.parse(localStorage.getItem('hist')||"[]");
        let d = document.getElementById('histList'); d.innerHTML="";
        h.forEach(x => {
            d.innerHTML += `<div class="hist-item"><div><b>${x.name}</b> <small>${x.date}</small></div>
            <button class="btn" onclick="loadH(${x.id})">YÃ¼kle</button></div>`;
        });
        document.getElementById('modalHist').style.display='block';
    }
    
    function loadH(id) {
        let h = JSON.parse(localStorage.getItem('hist')).find(a=>a.id==id);
        document.getElementById('targetCiro').value = h.ciro;
        calcLeft();
        let tb = document.querySelector('#tblRight tbody'); tb.innerHTML="";
        h.rows.forEach((r,i)=> { addRightRow(i, r.d, i===0?"PEÅÄ°NAT":i); tb.lastElementChild.querySelector('input[type=number]').value=r.t; });
        calcRight();
        document.getElementById('modalHist').style.display='none';
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Vade Sapmasi", 14, 20);
        doc.autoTable({ html: '#tblLeft', startY: 30 });
        doc.autoTable({ html: '#tblRight', startY: doc.lastAutoTable.finalY + 10 });
        doc.save('analiz.pdf');
    }

    function init() {
        if(localStorage.getItem('theme')==='dark') document.body.setAttribute('data-theme','dark');
        let d = document.getElementById('satisTarihi');
        if(!d.value) d.valueAsDate = new Date();
        calcLeft(); calcRight();
    }

    window.onload = function() {
        if(localStorage.getItem('logged')) {
            document.getElementById('login-screen').style.display='none';
            document.getElementById('app-container').style.display='block';
            init();
        }
        document.getElementById('targetCiro').addEventListener('input', calcLeft);
        document.getElementById('satisTarihi').addEventListener('change', ()=>{calcLeft(); calcRight();});
    }
</script>
</body>
</html>
