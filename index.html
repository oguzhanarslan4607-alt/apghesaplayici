<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vade Sapmasƒ± Analizi (By_Oƒüuz)</title>
    <style>
        /* --- TEMEL AYARLAR --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; padding: 0; margin: 0; color: #333; box-sizing: border-box; height: 100vh; }
        *, *:before, *:after { box-sizing: inherit; }
        
        /* --- Gƒ∞Rƒ∞≈û EKRANI --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #4a90e2, #0056b3);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: white; padding: 40px 30px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
            width: 90%; max-width: 400px;
        }
        .login-box h2 { margin: 0 0 20px; color: #333; }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 2px solid #eee; border-radius: 8px; font-size: 16px;
        }
        .login-input:focus { border-color: #4a90e2; outline: none; }
        .login-btn {
            width: 100%; padding: 12px; background-color: #4a90e2; color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: background 0.3s;
        }
        .login-btn:hover { background-color: #357abd; }
        .remember-me {
            display: flex; align-items: center; justify-content: flex-start;
            margin-bottom: 20px; font-size: 14px; color: #666;
        }
        .remember-me input { margin-right: 10px; width: 18px; height: 18px; }
        .error-msg { color: #ef5350; margin-bottom: 15px; font-size: 14px; display: none; font-weight: bold; }

        /* --- UYGULAMA KAPSAYICISI --- */
        #app-container { display: none; padding: 20px; max-width: 1280px; margin: 0 auto; padding-bottom: 80px; /* Footer i√ßin bo≈üluk */ }

        /* --- HEADER --- */
        .header-actions { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .btn-logout { background: #ff5252; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold; }

        /* --- TOP BAR --- */
        .top-bar { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 200px; }
        .input-group label { font-weight: 700; color: #555; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; transition: color 0.3s ease; }
        .top-bar input { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; color: #333; text-align: center; font-weight: bold; transition: border-color 0.3s; width: 100%; -webkit-appearance: none; }
        .top-bar input:focus { border-color: #4a90e2; outline: none; background-color: #fff; }
        #targetCiro { background-color: #eef6fc; color: #0d47a1; border-color: #bbdefb; }
        
        /* Klima Checkbox Stili */
        .klima-wrapper {
            display: flex; align-items: center; justify-content: center;
            background: #e0f7fa; padding: 10px; border-radius: 8px; border: 1px solid #b2ebf2;
            height: 50px; margin-bottom: 2px; cursor: pointer;
        }
        .klima-wrapper input { width: 20px; height: 20px; margin-right: 10px; cursor: pointer; }
        .klima-wrapper label { cursor: pointer; font-weight: bold; color: #006064; font-size: 14px; user-select: none; }
        
        /* ƒ∞stisnai Fiyat Aktif Class */
        .label-active {
            color: #00acc1 !important; /* Parlak Cyan/Mavi */
            text-shadow: 0 0 8px rgba(0,172,193,0.4);
            font-weight: 900 !important;
        }

        /* --- PANELLER --- */
        .main-wrapper { display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap; }
        .panel { flex: 1; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; min-width: 300px; }
        .panel h3 { margin: 0; padding: 15px; text-align: center; font-size: 15px; color: #fff; letter-spacing: 0.5px; text-transform: uppercase; font-weight: 600; position: relative; }
        .panel-left h3 { background-color: #4a90e2; } 
        .panel-right h3 { background-color: #66bb6a; } 

        .klima-badge {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: #fff; color: #006064; font-size: 10px; padding: 3px 8px;
            border-radius: 10px; font-weight: 900; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
        }

        /* --- TABLO --- */
        .table-container { padding: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 400px; }
        th { background-color: #f8f9fa; color: #555; padding: 12px 8px; text-align: center; font-weight: 700; border-bottom: 2px solid #eee; position: sticky; top: 0; background: #f8f9fa; z-index: 10; white-space: nowrap; }
        td { padding: 8px 5px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        
        input[type="number"].input-tutar { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: right; font-weight: 600; font-size: 14px; }
        input[type="date"].input-vade { width: 100%; padding: 7px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-family: inherit; font-size: 13px; -webkit-appearance: none; }
        .readonly-input { background-color: #f9f9f9; color: #777; border: 1px solid #eee !important; cursor: default; }

        .input-wrapper { position: relative; margin-top: 5px; }
        .pesinat-badge { position: absolute; top: -20px; left: 0; font-size: 10px; background-color: #ff9800; color: white; padding: 2px 6px; border-radius: 4px 4px 0 0; font-weight: bold; z-index: 5; box-shadow: 0 -1px 2px rgba(0,0,0,0.1); display: none; }
        tr.first-row .pesinat-badge { display: block; }
        tr.first-row td { padding-top: 15px; }

        /* --- BUTONLAR --- */
        .btn-delete { background-color: #ff5252; color: white; border: none; cursor: pointer; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(255, 82, 82, 0.3); margin: 0 auto; }
        .btn-container { display: flex; gap: 10px; padding: 10px 15px; }
        .btn-add { flex: 2; background-color: #f1f3f4; color: #333; border: 1px solid #ccc; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; touch-action: manipulation; }
        .btn-clear { flex: 1; background-color: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; }
        .btn-add:active, .btn-clear:active { transform: scale(0.98); opacity: 0.8; }

        /* --- √ñZET VE SONU√á --- */
        .summary-box { background-color: #f8f9fa; padding: 15px; border-top: 1px solid #eee; font-size: 13px; margin-top: auto; }
        .row-sum { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .val { font-weight: bold; color: #333; font-family: monospace; font-size: 14px; }
        .avg-row { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; color: #4a90e2; font-size: 14px; font-weight: 800; }
        
        .result-area { margin-top: 20px; background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .sapma-display { font-size: 28px; font-weight: 800; padding: 10px 20px; border-radius: 8px; min-width: 100px; text-align: center; color: #fff; }
        
        .positive-sapma { background-color: #ef5350; } 
        .negative-sapma { background-color: #66bb6a; } 
        .neutral-sapma { background-color: #bdbdbd; } 
        .warning-msg { color: #d32f2f; font-weight: bold; font-size: 12px; display: none; margin-top: 5px; text-align: left;}

        /* --- YASAL UYARI / NOT KUTUSU --- */
        .disclaimer-box {
            background-color: #fff8e1; /* Krem rengi */
            border-left: 5px solid #ffb300; /* Turuncu sol √ßizgi */
            padding: 15px;
            margin-top: 20px;
            border-radius: 6px;
            font-size: 13px;
            color: #5d4037;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .disclaimer-box h4 {
            margin: 0 0 10px;
            color: #e65100;
            font-size: 14px;
            font-weight: bold;
            display: flex; align-items: center; gap: 8px;
        }
        .disclaimer-box ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .disclaimer-box li { margin-bottom: 5px; }
        .disclaimer-box strong { color: #bf360c; }

        /* --- FOOTER / ƒ∞MZA STƒ∞LLERƒ∞ --- */
        .footer-signature {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            border-top: 1px dashed #ccc;
        }

        /* "Bƒ∞R KAHRAMANMARA≈û YAPIMIDIR" - Kƒ±rmƒ±zƒ±/Altƒ±n Parlama */
        .maras-text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 900;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            /* Arka plan gradyanƒ± */
            background: linear-gradient(to right, #b71c1c, #ffc107, #b71c1c);
            background-size: 200% auto;
            color: #b71c1c; /* Fallback */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            display: block;
            margin-bottom: 8px;
        }

        /* "By_Oƒüuz" - RGB Renk D√∂ng√ºs√º ve Pulse */
        .author-text {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            display: inline-block;
            animation: colorCycle 4s infinite alternate, pulse 2s infinite;
        }

        @keyframes shine {
            to { background-position: 200% center; }
        }

        @keyframes colorCycle {
            0% { color: #ff0000; text-shadow: 0 0 5px rgba(255,0,0,0.3); }
            25% { color: #00ff00; text-shadow: 0 0 5px rgba(0,255,0,0.3); }
            50% { color: #0000ff; text-shadow: 0 0 5px rgba(0,0,255,0.3); }
            75% { color: #ff00ff; text-shadow: 0 0 5px rgba(255,0,255,0.3); }
            100% { color: #ff0000; text-shadow: 0 0 5px rgba(255,0,0,0.3); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .main-wrapper { flex-direction: column; }
            .panel { width: 100%; min-width: auto; }
            .result-area { flex-direction: column; text-align: center; padding: 15px; }
            .sapma-display { width: 100%; margin-top: 10px; }
            .top-bar { flex-direction: column; align-items: stretch; }
            .top-bar input { font-size: 18px; padding: 10px; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2>Ho≈ü Geldiniz</h2>
        <div id="loginError" class="error-msg">Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±!</div>
        <input type="text" id="username" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±" value="ihlas">
        <input type="password" id="password" class="login-input" placeholder="≈ûifre" value="">
        <label class="remember-me">
            <input type="checkbox" id="rememberMe"> Beni Hatƒ±rla
        </label>
        <button class="login-btn" onclick="checkLogin()">Gƒ∞Rƒ∞≈û YAP</button>
    </div>
</div>

<div id="app-container">
    <div class="header-actions">
        <button class="btn-logout" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
    </div>

    <div class="top-bar">
        <div class="input-group">
            <label>FATURA / REFERANS TARƒ∞Hƒ∞</label>
            <input type="date" id="satisTarihi">
        </div>
        <div class="input-group">
            <label>FATURA TUTARI (Cƒ∞RO)</label>
            <input type="number" id="targetCiro" placeholder="√ñrn: 34000">
            <div id="ciroWarning" class="warning-msg">Bu tutar i√ßin tanƒ±mlƒ± plan yok!</div>
        </div>
        <div class="input-group" style="min-width: 150px;">
             <label id="istisnaiLabel">ƒ∞STƒ∞SNAƒ∞ Fƒ∞YAT</label>
             <div class="klima-wrapper" onclick="toggleKlima()">
                 <input type="checkbox" id="klimaMode" onchange="generateTargetPlan()">
                 <label for="klimaMode">‚ùÑÔ∏è KLƒ∞MA SATI≈ûI</label>
             </div>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="panel panel-left">
            <h3>
                OLMASI GEREKEN (HEDEF)
                <span id="klimaIndicator" class="klima-badge">KLƒ∞MA</span>
            </h3>
            <div class="table-container">
                <table id="tableLeft">
                    <thead>
                        <tr><th style="width:30px;">No</th><th>Tutar</th><th>Vade Tarihi</th><th>G√ºn</th><th>√áarpan</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="summary-box">
                <div class="row-sum"><span>Toplam Ciro:</span><span class="val" id="leftCiro">0,00</span></div>
                <div class="row-sum"><span>Vade √áarpan Top:</span><span class="val" id="leftGunTutar">0,00</span></div>
                <div class="row-sum avg-row"><span>Ort. Vade G√ºn√º:</span><span class="val" id="leftAvg">0,00</span></div>
            </div>
        </div>

        <div class="panel panel-right">
            <h3>GER√áEKLE≈ûEN (OLAN)</h3>
            <div class="table-container">
                <table id="tableRight">
                    <thead>
                        <tr>
                            <th style="width:30px;">Sil</th>
                            <th style="width:30px;">No</th>
                            <th>Tutar</th>
                            <th>Vade Tarihi</th>
                            <th>G√ºn</th>
                            <th>√áarpan</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="btn-container">
                <button class="btn-add" onclick="addManualRow()">+ √ñdeme Ekle</button>
                <button class="btn-clear" onclick="clearRightTable()">Temizle</button>
            </div>
            <div class="summary-box">
                <div class="row-sum"><span>Toplam Ciro:</span><span class="val" id="rightCiro">0,00</span></div>
                <div id="ciroStatusMsg" style="display:none; color:red; font-size:11px; text-align:right; font-weight:bold; margin-bottom:5px;">
                    ‚ö†Ô∏è Ciro E≈üit Deƒüil!
                </div>
                
                <div class="row-sum"><span>Vade √áarpan Top:</span><span class="val" id="rightGunTutar">0,00</span></div>
                <div class="row-sum avg-row" style="color: #66bb6a;"><span>Ort. Vade G√ºn√º:</span><span class="val" id="rightAvg">0,00</span></div>
            </div>
        </div>
    </div>

    <div class="result-area">
        <div style="color:#666; font-size:13px; flex:1;">
            Sol taraf otomatik dolar. Saƒü tarafa √∂demeleri ekleyin. ƒ∞lk satƒ±r Pe≈üinat'tƒ±r.
            <br><span style="color:#006064; font-weight:bold;">Not:</span> 31.000 ve 36.000 i√ßin Klima taksitlerini g√∂rmek isterseniz yukarƒ±dan "Klima Satƒ±≈üƒ±"nƒ± se√ßin.
        </div>
        <div style="text-align: center; min-width: 180px;">
            <div style="font-size: 16px; font-weight: 600; color: #555; margin-bottom: 5px;">VADE SAPMASI</div>
            <div class="sapma-display neutral-sapma" id="finalSapma">0,00</div>
        </div>
    </div>

    <div class="disclaimer-box">
        <h4>‚ö†Ô∏è √ñNEMLƒ∞ NOT</h4>
        <p>
            Payla≈üƒ±lan veriler ve hesaplamalar, Merkez tarafƒ±ndan belirlenen mevcut vade sapmasƒ± oranlarƒ± baz alƒ±narak hazƒ±rlanmƒ±≈ütƒ±r. 
            Bu oranlar piyasa ko≈üullarƒ±na veya merkez politikalarƒ±na g√∂re deƒüi≈üiklik g√∂sterebilir.
        </p>
        <p>Bu nedenle:</p>
        <ul>
            <li>Merkez oranlarƒ±nda herhangi bir g√ºncelleme yapƒ±lmasƒ± durumunda, l√ºtfen <strong>Muhasebe Departmanƒ±</strong> ile irtibata ge√ßiniz.</li>
            <li>Verileri kullanƒ±rken g√ºncelliƒüini teyit etmeniz ve deƒüi≈üen ko≈üullara kar≈üƒ± dikkatli olmanƒ±z √∂nem arz etmektedir.</li>
            <li><strong>Vade Sapmasƒ± oranƒ± 29'un altƒ±na d√º≈üerse</strong> satƒ±≈üƒ±n girme olasƒ±lƒ±ƒüƒ± istisnai durumlar haricinde vardƒ±r. Bu tablo bilgi ama√ßlƒ±dƒ±r.</li>
        </ul>
        <div style="margin-top:10px; font-style: italic; font-weight:600;">Bilgilerinize sunar, iyi √ßalƒ±≈ümalar dileriz.</div>
    </div>

    <div class="footer-signature">
        <span class="maras-text">üå∂Ô∏è Bƒ∞R KAHRAMANMARA≈û YAPIMIDIR üå∂Ô∏è</span>
        <span class="author-text">By_Oƒüuz</span>
    </div>

</div>

<script>
    // --- Gƒ∞Rƒ∞≈û ƒ∞≈ûLEMLERƒ∞ ---
    const CREDENTIALS = { user: "ihlas", pass: "1234" };

    function checkLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const remember = document.getElementById('rememberMe').checked;
        const errorDiv = document.getElementById('loginError');

        if (u === CREDENTIALS.user && p === CREDENTIALS.pass) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            if (remember) localStorage.setItem('isLoggedIn', 'true');
            initializeApp();
        } else {
            errorDiv.style.display = 'block';
        }
    }

    function logout() {
        localStorage.removeItem('isLoggedIn');
        location.reload();
    }

    function checkSession() {
        if (localStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            initializeApp();
        }
    }

    // --- HESAPLAMA KURALLARI ---
    
    // Standart Kurallar (31k ve 36k eski haline getirildi)
    const RULES = {
        24000: 2, 24500: 2,
        26000: 5, 27000: 5,
        28000: 8, 29000: 8,
        30000: 13, 
        31000: 13, // ESKƒ∞ HALƒ∞
        32000: 16, 33000: 16,
        34000: 19, 35000: 19,
        36000: 21, // ESKƒ∞ HALƒ∞
        37500: 13,
        43500: 5,
        50500: 10,
        55000: 13,
        63000: 2, 70000: 6,
        75000: 9, 80000: 13, 84000: 16
    };

    // Klima √ñzel Kurallarƒ± (G√∂rsellerdeki deƒüerler)
    const KLIMA_RULES = {
        31000: 5,
        36000: 10
    };

    function formatNum(num) { return num.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    
    function diffDays(d1, d2) {
        if(!d1 || !d2) return 0;
        const date1 = new Date(d1);
        const date2 = new Date(d2);
        const diffTime = date2 - date1;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    }

    function addMonths(dateStr, months) {
        let d = new Date(dateStr);
        d.setMonth(d.getMonth() + months);
        if (d.getDate() !== new Date(dateStr).getDate()) d.setDate(0);
        return d.toISOString().split('T')[0];
    }

    function getNextMonthFirstDay(baseDateStr) {
        let d = new Date(baseDateStr);
        d.setMonth(d.getMonth() + 1); 
        d.setDate(1);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        return `${year}-${month}-01`;
    }

    function toggleKlima() {
        generateTargetPlan();
    }

    function generateTargetPlan() {
        const ciroInput = parseFloat(document.getElementById('targetCiro').value);
        const refDate = document.getElementById('satisTarihi').value;
        const isKlima = document.getElementById('klimaMode').checked;
        const tbody = document.querySelector('#tableLeft tbody');
        const warningEl = document.getElementById('ciroWarning');
        const klimaBadge = document.getElementById('klimaIndicator');
        const istisnaiLabel = document.getElementById('istisnaiLabel');

        // LABEL RENK DEƒûƒ∞≈ûƒ∞Mƒ∞
        if(isKlima) {
            istisnaiLabel.classList.add('label-active');
        } else {
            istisnaiLabel.classList.remove('label-active');
        }
        
        tbody.innerHTML = ""; 
        klimaBadge.style.display = 'none';

        // Taksit sayƒ±sƒ± belirleme
        let installmentCount = 0;

        if (ciroInput) {
            // Eƒüer Klima modu a√ßƒ±ksa ve bu ciro i√ßin √∂zel klima kuralƒ± varsa onu kullan
            if (isKlima && KLIMA_RULES[ciroInput]) {
                installmentCount = KLIMA_RULES[ciroInput];
                klimaBadge.style.display = 'inline-block';
            } 
            // Yoksa standart kurallara bak
            else if (RULES[ciroInput]) {
                installmentCount = RULES[ciroInput];
            }
        }

        if (!ciroInput || !refDate || installmentCount === 0) {
            document.getElementById('leftCiro').textContent = "0,00";
            document.getElementById('leftGunTutar').textContent = "0,00";
            document.getElementById('leftAvg').textContent = "0,00";
            calculateFinalResult(); 
            if(ciroInput && installmentCount === 0) warningEl.style.display = 'block';
            else warningEl.style.display = 'none';
            return;
        }
        warningEl.style.display = 'none';

        const baseAmount = ciroInput / installmentCount;
        let currentTotal = 0;

        for (let i = 0; i < installmentCount; i++) {
            let amount = parseFloat(baseAmount.toFixed(2));
            if (i === installmentCount - 1) amount = ciroInput - currentTotal;
            currentTotal += amount;

            const vadeDate = (i === 0) ? refDate : addMonths(refDate, i);
            const gun = diffDays(refDate, vadeDate);
            const gunTutar = amount * gun;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center; font-weight:bold; color:#777;">${i+1}</td>
                <td><input type="text" class="input-tutar readonly-input" value="${formatNum(amount)}" readonly></td>
                <td><input type="date" class="input-vade readonly-input" value="${vadeDate}" readonly></td>
                <td class="cell-gun" style="text-align:center;">${gun}</td>
                <td class="cell-gun-tutar" style="text-align:right; font-size:12px;">${formatNum(gunTutar)}</td>
            `;
            tbody.appendChild(tr);
        }
        calculateSummary('tableLeft', 'leftCiro', 'leftGunTutar', 'leftAvg', true);
    }

    function updateRowNumbers() {
        const rows = document.querySelectorAll('#tableRight tbody tr');
        rows.forEach((row, index) => {
            const numCell = row.querySelector('.row-num');
            if (index === 0) {
                if(numCell) numCell.textContent = "-"; 
                row.classList.add('first-row');
            } else {
                if(numCell) numCell.textContent = index; 
                row.classList.remove('first-row');
            }
        });
    }

    function addManualRow() {
        const tbody = document.querySelector('#tableRight tbody');
        const rows = tbody.querySelectorAll('tr');
        const refDate = document.getElementById('satisTarihi').value;
        
        let targetDate;
        
        if (rows.length === 0) {
            targetDate = refDate;
        } else {
            const lastInput = rows[rows.length - 1].querySelector('.input-vade');
            const baseDate = (lastInput && lastInput.value) ? lastInput.value : refDate;
            targetDate = getNextMonthFirstDay(baseDate);
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:center;"><button class="btn-delete" onclick="deleteRow(this)">‚úï</button></td>
            <td class="row-num" style="text-align:center; font-weight:bold; color:#555;"></td>
            <td style="position:relative;">
                <div class="input-wrapper">
                    <span class="pesinat-badge">PE≈ûƒ∞NAT</span>
                    <input type="number" class="input-tutar" value="0" step="0.01" oninput="calculateRightSide()">
                </div>
            </td>
            <td><input type="date" class="input-vade" value="${targetDate}" onchange="calculateRightSide()"></td>
            <td class="cell-gun" style="text-align:center; color:#666;">0</td>
            <td class="cell-gun-tutar" style="text-align:right; color:#666; font-size:12px;">0,00</td>
        `;
        tbody.appendChild(tr);
        updateRowNumbers();
        calculateRightSide();
    }

    function deleteRow(btn) {
        btn.closest('tr').remove();
        updateRowNumbers();
        calculateRightSide();
    }

    function clearRightTable() {
        document.querySelector('#tableRight tbody').innerHTML = "";
        calculateRightSide();
    }

    function calculateRightSide() {
        calculateSummary('tableRight', 'rightCiro', 'rightGunTutar', 'rightAvg', false);
    }

    function calculateSummary(tblId, ciroId, gtId, avgId, isLocked) {
        const st = document.getElementById('satisTarihi').value;
        let totCiro = 0, totGT = 0;
        
        document.querySelectorAll(`#${tblId} tbody tr`).forEach(row => {
            let tutar = 0;
            if (isLocked) {
                const rawVal = row.querySelector('.input-tutar').value; 
                tutar = parseFloat(rawVal.replace(/\./g, '').replace(',', '.'));
            } else {
                tutar = parseFloat(row.querySelector('.input-tutar').value) || 0;
            }
            const vade = row.querySelector('.input-vade').value;
            const gun = (st && vade) ? diffDays(st, vade) : 0;
            const gt = tutar * gun;
            
            row.querySelector('.cell-gun').textContent = gun;
            row.querySelector('.cell-gun-tutar').textContent = formatNum(gt);
            totCiro += tutar;
            totGT += gt;
        });
        
        document.getElementById(ciroId).textContent = formatNum(totCiro);
        document.getElementById(gtId).textContent = formatNum(totGT);
        let avg = totCiro > 0.1 ? totGT / totCiro : 0;
        document.getElementById(avgId).textContent = formatNum(avg);
        calculateFinalResult();
    }

    function calculateFinalResult() {
        const parseTr = (id) => parseFloat(document.getElementById(id).textContent.replace(/\./g, '').replace(',', '.')) || 0;
        const leftAvg = parseTr('leftAvg');
        const rightAvg = parseTr('rightAvg');
        const leftCiro = parseTr('leftCiro');
        const rightCiro = parseTr('rightCiro');

        // --- Cƒ∞RO E≈ûƒ∞TLƒ∞K KONTROL√ú ---
        const targetInputVal = parseFloat(document.getElementById('targetCiro').value) || 0;
        const msgEl = document.getElementById('ciroStatusMsg');
        const rightCiroEl = document.getElementById('rightCiro');

        // 0.1 tolerans ile kontrol
        if (Math.abs(targetInputVal - rightCiro) > 0.1) {
            msgEl.style.display = 'block';
            rightCiroEl.style.color = '#d32f2f';
        } else {
            msgEl.style.display = 'none';
            rightCiroEl.style.color = '#333';
        }

        if (leftCiro === 0) {
            document.getElementById('finalSapma').textContent = "0,00";
            document.getElementById('finalSapma').className = "sapma-display neutral-sapma";
            return;
        }

        const sapma = rightAvg - leftAvg;
        const el = document.getElementById('finalSapma');
        el.textContent = formatNum(sapma);
        el.className = 'sapma-display';
        if (Math.abs(sapma) < 0.1) el.classList.add('neutral-sapma');
        else if (sapma > 0) el.classList.add('positive-sapma');
        else el.classList.add('negative-sapma');
    }

    function initializeApp() {
        const dateInput = document.getElementById('satisTarihi');
        if(!dateInput.value) dateInput.valueAsDate = new Date();
        generateTargetPlan();
        calculateRightSide();
    }

    window.onload = function() {
        checkSession();

        document.getElementById('targetCiro').addEventListener('input', generateTargetPlan);
        document.getElementById('satisTarihi').addEventListener('change', () => {
            generateTargetPlan();
            calculateRightSide();
        });
        
        document.getElementById('password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') checkLogin();
        });
    };
</script>
</body>
</html>
